<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Check-In</title>
  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
  <link href="https://fonts.googleapis.com/css2?family=Kanit:wght@300;400&display=swap" rel="stylesheet">
  <style>
    body { font-family: "Kanit", sans-serif; padding: 20px; text-align: center; background: #f0f2f5; }
    video { width: 100%; max-width: 400px; border-radius: 10px; background: #000; }
    .btn { padding: 15px; width: 45%; border: none; border-radius: 8px; font-size: 18px; color: white; margin: 10px 1%; cursor: pointer; }
    .in { background: #28a745; } .out { background: #ffc107; color: black; }
    #status { margin-top: 20px; color: #666; }
  </style>
</head>
<body>
  <h3>‡∏£‡∏∞‡∏ö‡∏ö‡∏•‡∏á‡πÄ‡∏ß‡∏•‡∏≤ (GitHub Ver.)</h3>
  <div id="profile">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...</div>
  <video id="video" autoplay playsinline></video>
  <canvas id="canvas" style="display:none;"></canvas>
  
  <div style="margin-top:20px;">
    <button class="btn in" onclick="sendData('‡πÄ‡∏Ç‡πâ‡∏≤‡∏á‡∏≤‡∏ô')">‡πÄ‡∏Ç‡πâ‡∏≤‡∏á‡∏≤‡∏ô</button>
    <button class="btn out" onclick="sendData('‡∏≠‡∏≠‡∏Å‡∏á‡∏≤‡∏ô')">‡∏≠‡∏≠‡∏Å‡∏á‡∏≤‡∏ô</button>
  </div>
  <div id="status"></div>

  <script>
    // üî¥ ‡πÅ‡∏Å‡πâ 2 ‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î‡∏ô‡∏µ‡πâ
    const LIFF_ID = "2008660878-lDaGV0kK"; 
    const GOOGLE_SCRIPT_URL = "https://script.google.com/macros/s/AKfycbxuo8IjM4zW9hqo_MOv1xSbWTv4m12wGibwaNoFkMhrelL7LODvrzE0fTyritRnZd0BGA/exec";

    const video = document.getElementById('video');
    
    // ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ó‡∏≥‡∏á‡∏≤‡∏ô
    navigator.mediaDevices.getUserMedia({ video: { facingMode: 'user' } }).then(s => video.srcObject = s);
    
    liff.init({ liffId: LIFF_ID }).then(() => {
      if (!liff.isLoggedIn()) { liff.login(); return; }
      liff.getProfile().then(p => {
        document.getElementById('profile').innerHTML = `‡∏™‡∏ß‡∏±‡∏™‡∏î‡∏µ: <b>${p.displayName}</b>`;
        document.getElementById('profile').dataset.uid = p.userId;
        document.getElementById('profile').dataset.name = p.displayName;
      });
    });

    function sendData(type) {
      const status = document.getElementById('status');
      status.innerText = "‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...";
      
      if(!navigator.geolocation) return status.innerText = "‡πÑ‡∏°‡πà‡∏û‡∏ö GPS";
      
      navigator.geolocation.getCurrentPosition(pos => {
        const canvas = document.getElementById('canvas');
        canvas.width = 600; 
        canvas.height = video.videoHeight * (600/video.videoWidth);
        canvas.getContext('2d').drawImage(video, 0, 0, canvas.width, canvas.height);
        
        const payload = {
          name: document.getElementById('profile').dataset.name,
          userId: document.getElementById('profile').dataset.uid,
          type: type,
          location: pos.coords.latitude + "," + pos.coords.longitude,
          image: canvas.toDataURL('image/jpeg', 0.6)
        };

        fetch(GOOGLE_SCRIPT_URL, {
          method: 'POST',
          mode: 'no-cors',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload)
        }).then(() => {
          status.innerText = "‚úÖ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!";
          setTimeout(() => liff.closeWindow(), 2000);
        }).catch(err => status.innerText = "Error: " + err);
      });
    }
  </script>
</body>
</html>
