<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>‡∏£‡∏∞‡∏ö‡∏ö‡∏•‡∏á‡πÄ‡∏ß‡∏•‡∏≤ - 9 Auto Garage</title>
  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
  <link href="https://fonts.googleapis.com/css2?family=Kanit:wght@300;400;600&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
   
  <style>
    body { 
      margin: 0; padding: 20px; 
      font-family: "Kanit", sans-serif; 
      background: #212529; 
      color: #fff;
      display: flex; flex-direction: column; align-items: center; 
      min-height: 100vh; 
    }

    .card { 
      background: #fff; color: #333;
      border-radius: 15px; 
      box-shadow: 0 10px 30px rgba(0,0,0,0.5);
      width: 100%; max-width: 380px; 
      padding: 30px 20px; 
      box-sizing: border-box; 
      text-align: center; 
      border-top: 5px solid #d63031;
    }

    .logo-img { width: 120px; height: auto; object-fit: contain; margin-bottom: 15px; display: block; margin-left: auto; margin-right: auto; }
    h2 { margin: 0; color: #2d3436; font-weight: 700; text-transform: uppercase; }
    h4 { margin: 5px 0 20px 0; color: #636e72; font-weight: 300; font-size: 14px; }
    
    .camera-box { 
      width: 100%; aspect-ratio: 3/4; 
      background: #000; border-radius: 10px; 
      overflow: hidden; position: relative; 
      margin-bottom: 20px; 
      border: 2px solid #333;
      box-shadow: inset 0 0 20px rgba(0,0,0,0.5);
    }
    video, canvas { width: 100%; height: 100%; object-fit: cover; }

    #profile-display { 
      margin-bottom: 15px; font-size: 14px; color: #444; 
      background: #dfe6e9; padding: 8px; border-radius: 30px;
      display: inline-flex; align-items: center; padding-right: 20px;
    }
    .profile-pic { width: 30px; height: 30px; border-radius: 50%; margin-right: 10px; }

    .btn-group { display: flex; gap: 10px; width: 100%; }
    
    button { 
      flex: 1; padding: 15px; border: none; border-radius: 8px; 
      font-size: 18px; font-family: "Kanit", sans-serif; font-weight: 600;
      cursor: not-allowed; color: #fff; 
      background-color: #b2bec3;
      transition: all 0.2s; 
      display: flex; align-items: center; justify-content: center; gap: 8px;
    }
    
    .btn-active { cursor: pointer !important; transform: scale(1); box-shadow: 0 4px 0 rgba(0,0,0,0.2); }
    .btn-active:active { transform: translateY(4px); box-shadow: none; }
    .btn-in.btn-active { background: #00b894; }
    .btn-out.btn-active { background: #e17055; }

    #status { margin-top: 15px; font-size: 14px; color: #666; min-height: 20px; }
    .loading { color: #0984e3; font-weight: bold; }

    /* Success Modal */
    .modal-overlay {
      position: fixed; top: 0; left: 0; width: 100%; height: 100%;
      background: rgba(0,0,0,0.8); display: none;
      justify-content: center; align-items: center; z-index: 1000;
    }
    .modal-box {
      background: white; width: 85%; max-width: 320px; padding: 30px; border-radius: 15px;
      text-align: center; color: #333; box-shadow: 0 15px 40px rgba(0,0,0,0.5);
      animation: popUp 0.3s;
    }
    .modal-icon { font-size: 60px; color: #00b894; margin-bottom: 15px; }
    .modal-title { font-size: 22px; font-weight: bold; margin-bottom: 10px; }
    .countdown { font-weight: bold; color: #d63031; font-size: 18px; }

    @keyframes popUp { from { transform: scale(0.5); opacity: 0; } to { transform: scale(1); opacity: 1; } }
  </style>
</head>
<body>

  <div class="card">
    <img src="logo.png" class="logo-img" alt="Logo" onerror="this.style.display='none'">
    <h2>‡∏£‡∏∞‡∏ö‡∏ö‡∏•‡∏á‡πÄ‡∏ß‡∏•‡∏≤</h2>
    <h4>9 Auto Garage</h4>
    
    <div id="profile-display"><i class="fas fa-circle-notch fa-spin"></i> ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠ LINE...</div>

    <div class="camera-box">
      <video id="video" autoplay playsinline></video>
      <canvas id="canvas" style="display:none;"></canvas>
    </div>

    <div class="btn-group">
      <button id="btnIn" class="btn-in" onclick="startProcess('‡πÄ‡∏Ç‡πâ‡∏≤‡∏á‡∏≤‡∏ô')">
        <i class="fas fa-sign-in-alt"></i> ‡πÄ‡∏Ç‡πâ‡∏≤‡∏á‡∏≤‡∏ô
      </button>
      <button id="btnOut" class="btn-out" onclick="startProcess('‡∏≠‡∏≠‡∏Å‡∏á‡∏≤‡∏ô')">
        <i class="fas fa-sign-out-alt"></i> ‡∏≠‡∏≠‡∏Å‡∏á‡∏≤‡∏ô
      </button>
    </div>

    <div id="status"></div>
  </div>

  <div id="modalSuccess" class="modal-overlay">
    <div class="modal-box">
      <div class="modal-icon"><i class="fas fa-check-circle"></i></div>
      <div class="modal-title">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!</div>
      <div>‡∏õ‡∏¥‡∏î‡πÉ‡∏ô <span id="timer" class="countdown">3</span> ‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ</div>
    </div>
  </div>

  <input type="hidden" id="userId"><input type="hidden" id="userName">

  <script>
    // **********************************************
    // ‚ö†Ô∏è LIFF ID ‡πÄ‡∏î‡∏¥‡∏°
    const LIFF_ID = "2008842599-sBEZKztr"; 
    // ‚úÖ URL ‡∏™‡∏Ñ‡∏£‡∏¥‡∏õ‡∏ï‡πå (‡πÄ‡∏ä‡πá‡∏Ñ‡πÉ‡∏´‡πâ‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ö Deploy ‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î)
    const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbwFlkL7tlZBvHxXH0dJq2fJboacSXCpBgOoC2_rP2BtxqvplKdz4T2C9gLnSOqtAiJN/exec";
    // **********************************************

    const video = document.getElementById('video');
    const canvas = document.getElementById('canvas');
    const statusEl = document.getElementById('status');
    const btnIn = document.getElementById('btnIn');
    const btnOut = document.getElementById('btnOut');

    window.onload = async () => {
      startCamera();
      await initLiff();
    };

    async function initLiff() {
      try {
        await liff.init({ liffId: LIFF_ID });
        if (!liff.isLoggedIn()) { liff.login(); return; }
        const profile = await liff.getProfile();
        document.getElementById('userId').value = profile.userId;
        document.getElementById('userName').value = profile.displayName;
        document.getElementById('profile-display').innerHTML = `<img src="${profile.pictureUrl}" class="profile-pic"> ${profile.displayName}`;
        unlockButtons();
      } catch (err) { statusEl.innerText = "Error LIFF: " + err.message; }
    }

    function unlockButtons() {
      btnIn.classList.add('btn-active'); btnOut.classList.add('btn-active');
    }

    function startCamera() {
      navigator.mediaDevices.getUserMedia({ video: { facingMode: 'user' } })
        .then(stream => { video.srcObject = stream; })
        .catch(err => { statusEl.innerText = "‡πÄ‡∏õ‡∏¥‡∏î‡∏Å‡∏•‡πâ‡∏≠‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ: " + err; });
    }

    // üéØ ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏´‡∏•‡∏±‡∏Å: Snap -> Freeze -> Send
    function startProcess(type) {
      if(!btnIn.classList.contains('btn-active')) return;

      // 1. üì∏ SNAP & FREEZE ‡∏ó‡∏±‡∏ô‡∏ó‡∏µ!
      captureImage(); 
      video.style.display = 'none'; // ‡∏ã‡πà‡∏≠‡∏ô‡∏ß‡∏¥‡∏î‡∏µ‡πÇ‡∏≠
      canvas.style.display = 'block'; // ‡πÇ‡∏ä‡∏ß‡πå‡∏†‡∏≤‡∏û‡∏ô‡∏¥‡πà‡∏á‡πÅ‡∏ó‡∏ô
      
      // ‡∏•‡πá‡∏≠‡∏Ñ‡∏õ‡∏∏‡πà‡∏°
      btnIn.classList.remove('btn-active');
      btnOut.classList.remove('btn-active');
      statusEl.className = 'loading';
      statusEl.innerHTML = '<i class="fas fa-spinner fa-spin"></i> ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏£‡∏∞‡∏ö‡∏∏‡∏û‡∏¥‡∏Å‡∏±‡∏î‡πÅ‡∏•‡∏∞‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...';

      // 2. üìç ‡∏´‡∏≤ GPS
      if(!navigator.geolocation) { handleError("‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏ô‡∏µ‡πâ‡πÑ‡∏°‡πà‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö GPS"); return; }
      
      navigator.geolocation.getCurrentPosition(
        (pos) => {
           // 3. üöÄ ‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
           sendDataToScript(type, pos);
        },
        (err) => {
           handleError("‡πÄ‡∏õ‡∏¥‡∏î GPS ‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: " + err.message);
        },
        { timeout: 10000, enableHighAccuracy: true }
      );
    }

    function captureImage() {
      const ctx = canvas.getContext('2d');
      const MAX_WIDTH = 600; 
      let width = video.videoWidth;
      let height = video.videoHeight;
      if (width > MAX_WIDTH) {
         height = height * (MAX_WIDTH / width);
         width = MAX_WIDTH;
      }
      canvas.width = width;
      canvas.height = height;
      ctx.drawImage(video, 0, 0, width, height);
    }

    function sendDataToScript(type, pos) {
      const payload = {
         name: document.getElementById('userName').value,
         userId: document.getElementById('userId').value,
         type: type,
         location: pos.coords.latitude + "," + pos.coords.longitude,
         image: canvas.toDataURL('image/jpeg', 0.6) // ‡∏£‡∏π‡∏õ‡∏ó‡∏µ‡πà Snap ‡πÑ‡∏ß‡πâ‡πÅ‡∏•‡πâ‡∏ß
      };

      fetch(SCRIPT_URL, {
         method: 'POST', mode: 'no-cors', headers: { 'Content-Type': 'application/json' },
         body: JSON.stringify(payload)
      })
      .then(() => showSuccessModal())
      .catch(err => handleError("‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏°‡πà‡∏ú‡πà‡∏≤‡∏ô: " + err));
    }

    function handleError(msg) {
       statusEl.style.color = 'red';
       statusEl.innerText = msg;
       // ‡∏ñ‡πâ‡∏≤‡∏û‡∏±‡∏á ‡πÉ‡∏´‡πâ‡∏Å‡∏•‡∏±‡∏ö‡∏°‡∏≤‡πÄ‡∏õ‡∏¥‡∏î‡∏Å‡∏•‡πâ‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà
       video.style.display = 'block';
       canvas.style.display = 'none';
       unlockButtons();
    }

    function showSuccessModal() {
      const modal = document.getElementById('modalSuccess');
      const timerSpan = document.getElementById('timer');
      let timeLeft = 3;
      statusEl.innerHTML = '';
      modal.style.display = 'flex';
      const interval = setInterval(() => {
        timeLeft--;
        timerSpan.innerText = timeLeft;
        if (timeLeft <= 0) {
           clearInterval(interval);
           if(liff.isInClient()) liff.closeWindow();
           else window.location.reload();
        }
      }, 1000);
    }
  </script>
</body>
</html>
