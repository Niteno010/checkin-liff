<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>‡πô ‡∏≠‡∏≠‡πÇ‡∏ï‡πâ ‡∏Å‡∏≤‡∏£‡∏≤‡∏à - Ultimate</title>
    <link href="https://fonts.googleapis.com/css2?family=Kanit:wght@300;400;500;600&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root { --bg: #f8f9fa; --primary: #1a1a1a; --accent: #ff3b30; --success: #28a745; --text: #333; --card: #fff; }
        body { font-family: 'Kanit', sans-serif; background: var(--bg); color: var(--text); margin: 0; padding-bottom: 80px; }
        .container { padding: 15px; max-width: 600px; margin: 0 auto; }
        
        /* Navigation */
        .bottom-nav { position: fixed; bottom: 0; left: 0; width: 100%; background: #fff; display: flex; box-shadow: 0 -2px 10px rgba(0,0,0,0.1); z-index: 1000; padding-bottom: env(safe-area-inset-bottom); }
        .nav-item { flex: 1; text-align: center; padding: 12px 0; color: #999; font-size: 12px; cursor: pointer; position: relative; }
        .nav-item i { display: block; font-size: 20px; margin-bottom: 3px; }
        .nav-item.active { color: var(--accent); }
        .badge { position: absolute; top: 5px; right: 25vw; background: var(--accent); color: #fff; font-size: 10px; padding: 2px 6px; border-radius: 10px; font-weight: bold; display: none; }

        /* Tabs */
        .tab-content { display: none; animation: fadeIn 0.3s; }
        .tab-content.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; } }

        /* UI Elements */
        .search-box { background: var(--card); padding: 12px; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.05); margin-bottom: 15px; position: sticky; top: 10px; z-index: 100; }
        input, textarea, select { width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 8px; font-family: 'Kanit'; font-size: 16px; box-sizing: border-box; background: #f9f9f9; }
        input:focus, textarea:focus, select:focus { outline: none; border-color: var(--accent); background: #fff; }
        .item-card { background: var(--card); padding: 15px; border-radius: 12px; margin-bottom: 12px; border-left: 4px solid var(--primary); box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        
        /* Cart Styles (Checkbox & Qty) */
        .cart-item { background: #fff; padding: 12px; border-radius: 10px; margin-bottom: 10px; border: 1px solid #eee; display: flex; flex-direction: column; gap: 8px; transition: 0.3s; }
        .cart-row-top { display: flex; align-items: flex-start; gap: 10px; }
        .cart-row-bottom { display: flex; justify-content: space-between; align-items: center; background: #f9f9f9; padding: 8px; border-radius: 6px; }
        .qty-controls { display: flex; align-items: center; gap: 12px; background: #fff; border: 1px solid #ddd; border-radius: 6px; padding: 2px 8px; }
        .qty-btn { background: none; border: none; font-size: 18px; color: var(--accent); font-weight: bold; cursor: pointer; padding: 0 5px; }
        .price-input { width: 90px !important; text-align: right; font-weight: bold; color: var(--success); border: none !important; background: transparent !important; }
        
        /* Total & Buttons */
        .total-banner { background: var(--primary); color: #fff; padding: 15px; border-radius: 12px; text-align: right; font-size: 20px; font-weight: bold; margin: 15px 0; }
        .btn-main { width: 100%; padding: 15px; border: none; border-radius: 12px; font-family: 'Kanit'; font-size: 16px; font-weight: bold; cursor: pointer; }
        .btn-primary { background: var(--accent); color: #fff; }
        .btn-bill { background: #007bff; color: #fff; margin-bottom: 10px; }

        /* Timeline History */
        .history-card { background: #fff; padding: 15px; border-radius: 12px; margin-bottom: 15px; position: relative; border-top: 5px solid #ddd; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        .status-tag { position: absolute; top: 10px; right: 10px; font-size: 11px; padding: 3px 8px; border-radius: 20px; font-weight:bold; }
        .status-closed { background: #e8f5e9; color: var(--success); }
        .status-pending { background: #fff3cd; color: #856404; }

        /* Modal E-Slip */
        .modal { display: none; position: fixed; z-index: 2000; left:0; top:0; width:100%; height:100%; background: rgba(0,0,0,0.7); }
        .modal-content { background:#fff; margin:5vh auto; padding:20px; width:90%; max-width:450px; border-radius:15px; max-height:85vh; overflow-y:auto; }
        #bill-capture-area { background: #fff; padding: 20px; color: #000; border: 1px solid #ddd; border-radius:8px; }
        .bill-header { text-align: center; border-bottom: 2px dashed #eee; padding-bottom: 10px; margin-bottom: 15px; }
        .bill-table { width: 100%; border-collapse: collapse; font-size: 14px; }
        .bill-table th { text-align: left; border-bottom: 1px solid #eee; padding: 5px; }
        .bill-table td { padding: 8px 5px; border-bottom: 1px dotted #eee; }
    </style>
</head>
<body>

<div id="tab-search" class="tab-content container active">
    <div class="search-box">
        <input type="text" id="searchInput" placeholder="üîç ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏≠‡∏∞‡πÑ‡∏´‡∏•‡πà/‡∏£‡∏∏‡πà‡∏ô‡∏£‡∏ñ..." onkeyup="filterItems()">
    </div>
    <div id="loading" style="text-align:center; padding:20px; color:#888;"><i class="fas fa-spinner fa-spin"></i> ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏ê‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...</div>
    <div id="resultsList"></div>
</div>

<div id="tab-job" class="tab-content container">
    <div style="display:flex; gap:10px; margin-bottom:15px; background:#e0e0e0; padding:4px; border-radius:10px;">
        <button onclick="setJobMode('new')" id="btn-m-new" style="flex:1; padding:12px; border-radius:8px; border:none; background:#fff; color:var(--primary); font-weight:bold; box-shadow:0 2px 5px rgba(0,0,0,0.1);">üÜï ‡∏£‡∏ñ‡πÉ‡∏´‡∏°‡πà</button>
        <button onclick="setJobMode('update')" id="btn-m-upd" style="flex:1; padding:12px; border-radius:8px; border:none; background:transparent; color:#666; font-weight:bold;">üõ†Ô∏è ‡∏Ñ‡πâ‡∏≤‡∏á‡∏ã‡πà‡∏≠‡∏°</button>
    </div>

    <div id="mode-new">
        <div style="display:grid; grid-template-columns:1fr 1fr; gap:10px; margin-bottom:10px;">
            <input type="text" id="new-plate" placeholder="‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡∏£‡∏ñ *">
            <input type="number" id="new-mileage" placeholder="‡πÄ‡∏•‡∏Ç‡πÑ‡∏°‡∏•‡πå *">
        </div>
        <input type="text" id="new-model" placeholder="‡∏£‡∏∏‡πà‡∏ô‡∏£‡∏ñ / ‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£" style="margin-bottom:10px;">
        <textarea id="new-symptoms" placeholder="‡∏≠‡∏≤‡∏Å‡∏≤‡∏£‡∏ó‡∏µ‡πà‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡πÅ‡∏à‡πâ‡∏á..." style="margin-bottom:15px;"></textarea>
        <button class="btn-main btn-primary" onclick="saveNewJob()">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏£‡∏±‡∏ö‡∏£‡∏ñ‡πÄ‡∏Ç‡πâ‡∏≤‡∏≠‡∏π‡πà</button>
    </div>

    <div id="mode-update" style="display:none;">
        <label style="font-size:14px; font-weight:bold; color:#555;"><i class="fas fa-car-side"></i> ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏ñ‡∏ó‡∏µ‡πà‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ó‡∏≥</label>
        <select id="active-jobs-select" onchange="loadActiveJobData()" style="margin-bottom:15px; font-weight:bold;">
            <option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏ñ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• --</option>
        </select>
        
        <h3 style="font-size:16px; border-bottom:2px solid #eee; padding-bottom:5px; margin-top:0;"><i class="fas fa-wrench"></i> ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏≠‡∏∞‡πÑ‡∏´‡∏•‡πà / ‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô</h3>
        <div id="cartList" style="margin-bottom:10px;"></div>
        
        <button onclick="addCustomItem()" style="width:100%; padding:12px; border:1px dashed #aaa; background:#fff; margin-bottom:15px; border-radius:8px; font-family:'Kanit'; cursor:pointer; color:#555;">
            + ‡∏û‡∏¥‡∏°‡∏û‡πå‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÄ‡∏≠‡∏á / ‡∏Ñ‡πà‡∏≤‡πÅ‡∏£‡∏á
        </button>
        
        <label style="font-size:14px; font-weight:bold; color:#555;">‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏≠‡∏≤‡∏Å‡∏≤‡∏£ (‡∏û‡∏¥‡∏°‡∏û‡πå‡πÅ‡∏Å‡πâ‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏¢)</label>
        <textarea id="update-details" placeholder="‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏∞‡∏î‡∏∂‡∏á‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡πÄ‡∏î‡∏¥‡∏°‡∏°‡∏≤‡πÅ‡∏™‡∏î‡∏á..." style="margin-bottom:10px;"></textarea>
        
        <div class="total-banner">‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏°‡∏™‡∏∏‡∏ó‡∏ò‡∏¥: <span id="grandTotal">0</span> ‡∏ø</div>
        
        <div style="background:#e8f4f8; padding:15px; border-radius:12px; margin-bottom:15px; border:1px solid #b8daff;">
            <label style="color:#0056b3; font-weight:bold;"><i class="fas fa-flag-checkered"></i> ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏Å‡∏≤‡∏£‡∏ã‡πà‡∏≠‡∏°</label>
            <select id="update-status" style="font-weight:bold; color:#333; margin-top:5px;">
                <option value="‡∏£‡∏≠‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£">‚è≥ ‡∏£‡∏≠‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£ (‡∏î‡∏≠‡∏á‡πÑ‡∏ß‡πâ‡∏ó‡∏≥‡∏ï‡πà‡∏≠)</option>
                <option value="‡πÅ‡∏Ñ‡πà‡πÄ‡∏™‡∏ô‡∏≠‡∏£‡∏≤‡∏Ñ‡∏≤">üìù ‡πÄ‡∏™‡∏ô‡∏≠‡∏£‡∏≤‡∏Ñ‡∏≤ / ‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡πÄ‡∏•‡∏∑‡πà‡∏≠‡∏ô</option>
                <option value="‡∏õ‡∏¥‡∏î‡∏à‡πä‡∏≠‡∏ö">‚úÖ ‡∏õ‡∏¥‡∏î‡∏à‡πä‡∏≠‡∏ö (‡πÄ‡∏Å‡πá‡∏ö‡πÄ‡∏á‡∏¥‡∏ô‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤)</option>
            </select>
        </div>
        
        <button class="btn-main btn-bill" onclick="showBill()"><i class="fas fa-file-invoice"></i> ‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÉ‡∏ö‡πÄ‡∏™‡∏ô‡∏≠‡∏£‡∏≤‡∏Ñ‡∏≤ (E-Slip)</button>
        <button class="btn-main btn-primary" onclick="updateJob()"><i class="fas fa-save"></i> ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</button>
    </div>
</div>

<div id="tab-history" class="tab-content container">
    <div class="search-box">
        <input type="text" id="histSearchPlate" placeholder="üîç ‡πÉ‡∏™‡πà‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏î‡∏π‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥..." onkeyup="if(event.key==='Enter')searchHistory()">
        <button onclick="searchHistory()" style="margin-top:10px; width:100%; padding:12px; background:var(--primary); color:#fff; border:none; border-radius:8px; font-family:'Kanit'; font-weight:bold;"><i class="fas fa-search"></i> ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥</button>
    </div>
    <div id="historyResults"></div>
</div>

<div id="bill-modal" class="modal">
    <div class="modal-content">
        <div id="bill-capture-area">
            <div class="bill-header">
                <h2 style="margin:0;">‡πô ‡∏≠‡∏≠‡πÇ‡∏ï‡πâ ‡∏Å‡∏≤‡∏£‡∏≤‡∏à</h2>
                <p style="font-size:12px; margin:5px 0; color:#666;">‡πÉ‡∏ö‡πÄ‡∏™‡∏ô‡∏≠‡∏£‡∏≤‡∏Ñ‡∏≤ / ‡∏™‡∏£‡∏∏‡∏õ‡∏á‡∏≤‡∏ô‡∏ã‡πà‡∏≠‡∏°</p>
                <div style="font-size:13px; text-align:left; margin-top:15px; background:#f9f9f9; padding:10px; border-radius:8px;">
                    <b>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà:</b> <span id="bill-date"></span><br>
                    <b>‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô:</b> <span id="bill-plate" style="color:var(--accent); font-weight:bold;"></span><br>
                    <b>‡πÑ‡∏°‡∏•‡πå:</b> <span id="bill-mile"></span>
                </div>
            </div>
            <table class="bill-table">
                <thead><tr><th>‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</th><th style="text-align:right;">‡∏£‡∏≤‡∏Ñ‡∏≤(‡∏ø)</th></tr></thead>
                <tbody id="bill-items-body"></tbody>
            </table>
            <div style="text-align:right; margin-top:15px; font-size:18px; font-weight:bold; color:var(--success);">
                ‡∏¢‡∏≠‡∏î‡∏™‡∏∏‡∏ó‡∏ò‡∏¥: <span id="bill-total"></span>
            </div>
        </div>
        <p style="text-align:center; font-size:12px; color:#aaa; margin-top:10px;"><i class="fas fa-camera"></i> ‡πÅ‡∏Ñ‡∏õ‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠‡∏ô‡∏µ‡πâ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏™‡πà‡∏á‡πÉ‡∏´‡πâ‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏¢</p>
        <button onclick="document.getElementById('bill-modal').style.display='none'" style="width:100%; margin-top:10px; padding:12px; border:none; background:#333; color:#fff; border-radius:8px; font-family:'Kanit'; font-weight:bold;">‡∏õ‡∏¥‡∏î‡∏´‡∏ô‡πâ‡∏≤‡∏ï‡πà‡∏≤‡∏á</button>
    </div>
</div>

<nav class="bottom-nav">
    <div class="nav-item active" onclick="switchTab('search', this)"><i class="fas fa-search"></i>‡∏≠‡∏∞‡πÑ‡∏´‡∏•‡πà</div>
    <div class="nav-item" onclick="switchTab('job', this)">
        <i class="fas fa-clipboard-list"></i>‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏à‡πä‡∏≠‡∏ö
        <span class="badge" id="cartBadge">0</span> </div>
    <div class="nav-item" onclick="switchTab('history', this)"><i class="fas fa-history"></i>‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥</div>
</nav>

<script>
    // ‡πÉ‡∏ä‡πâ API ‡∏ï‡∏±‡∏ß‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡∏≠‡∏≤‡∏£‡πå‡∏°
    const API = "https://script.google.com/macros/s/AKfycbzac8creM9vxDSr15EeJINO03ND-7HaPgKJKnJEvLbILstu1UvqZL30cLTUUJDxOEuaxw/exec";
    let allItems = [], activeJobs = [], cart = [];

    fetch(API).then(r=>r.json()).then(d=>{ 
        if(d.status==='success'){
            allItems=d.data; 
            document.getElementById('loading').style.display='none'; 
            renderItems(allItems);
        } 
    });

    // =====================================
    // ‡∏™‡∏•‡∏±‡∏ö‡πÅ‡∏ó‡πá‡∏ö / ‡πÇ‡∏´‡∏°‡∏î
    // =====================================
    function switchTab(t, el) {
        document.querySelectorAll('.tab-content').forEach(c=>c.classList.remove('active'));
        document.querySelectorAll('.nav-item').forEach(i=>i.classList.remove('active'));
        document.getElementById('tab-'+t).classList.add('active');
        el.classList.add('active');
        if(t==='job') fetchActiveJobs();
    }

    function setJobMode(m) {
        document.getElementById('mode-new').style.display = m==='new'?'block':'none';
        document.getElementById('mode-update').style.display = m==='update'?'block':'none';
        
        document.getElementById('btn-m-new').style.background = m==='new'?'#fff':'#eee';
        document.getElementById('btn-m-new').style.color = m==='new'?'var(--primary)':'#666';
        
        document.getElementById('btn-m-upd').style.background = m==='update'?'#fff':'#eee';
        document.getElementById('btn-m-upd').style.color = m==='update'?'var(--primary)':'#666';
    }

    // =====================================
    // ‚úÖ ‡πÅ‡∏Å‡πâ‡∏ö‡∏±‡∏Ñ: ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏≠‡∏∞‡πÑ‡∏´‡∏•‡πà
    // =====================================
    function filterItems() {
        const text = document.getElementById('searchInput').value.toLowerCase();
        const filtered = allItems.filter(item => 
            (item.name || '').toLowerCase().includes(text) || 
            (item.model || '').toLowerCase().includes(text)
        );
        renderItems(filtered);
    }

    function renderItems(items) {
        const list = document.getElementById('resultsList'); list.innerHTML = '';
        if(items.length === 0) { list.innerHTML = '<div style="text-align:center;color:#888;">‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</div>'; return; }
        items.forEach(i => {
            list.innerHTML += `<div class="item-card">
                <div style="display:flex;justify-content:space-between">
                    <b style="font-size:15px; color:var(--primary);">${i.name}</b>
                    <span style="color:var(--success); font-weight:bold;">${i.sellPrice} ‡∏ø</span>
                </div>
                <div style="font-size:12px;color:#666; margin-top:3px;">‡∏£‡∏∏‡πà‡∏ô: ${i.model}</div>
                <button onclick="addToCart('${i.name}', ${i.sellPrice})" style="width:100%;margin-top:10px;padding:8px;border:none;background:#e8f5e9;color:var(--success);border-radius:8px;font-family:'Kanit';font-weight:bold;">+ ‡πÉ‡∏™‡πà‡∏ö‡∏¥‡∏•</button>
            </div>`;
        });
    }

    // =====================================
    // ‡∏£‡∏∞‡∏ö‡∏ö‡∏ï‡∏∞‡∏Å‡∏£‡πâ‡∏≤ (Checkbox + Qty)
    // =====================================
    function addToCart(name, price) {
        cart.push({ name: name, price: price, qty: 1, checked: true });
        updateCartUI();
        alert(`‡πÄ‡∏û‡∏¥‡πà‡∏° "${name}" ‡∏•‡∏á‡∏ï‡∏∞‡∏Å‡∏£‡πâ‡∏≤‡πÅ‡∏•‡πâ‡∏ß!`);
    }

    function addCustomItem() {
        const n = prompt("‡∏û‡∏¥‡∏°‡∏û‡πå‡∏ä‡∏∑‡πà‡∏≠‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£:"); if(!n) return;
        const p = prompt("‡∏£‡∏≤‡∏Ñ‡∏≤ (‡∏ñ‡πâ‡∏≤‡∏ü‡∏£‡∏µ‡πÉ‡∏™‡πà 0):", "0"); 
        cart.push({ name:n, price:Number(p)||0, qty:1, checked:true }); updateCartUI();
    }

    function updateCartUI() {
        const list = document.getElementById('cartList'); 
        const badge = document.getElementById('cartBadge');
        
        // ‚úÖ ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô
        if(cart.length > 0) { badge.style.display = 'block'; badge.innerText = cart.length; } 
        else { badge.style.display = 'none'; }

        list.innerHTML = '';
        if(cart.length === 0) list.innerHTML = '<div style="text-align:center; padding:15px; background:#eee; border-radius:8px; color:#888;">‡∏ö‡∏¥‡∏•‡∏ß‡πà‡∏≤‡∏á‡πÄ‡∏õ‡∏•‡πà‡∏≤</div>';
        
        cart.forEach((item, idx) => {
            list.innerHTML += `<div class="cart-item" style="opacity: ${item.checked ? 1 : 0.5}">
                <div class="cart-row-top">
                    <input type="checkbox" ${item.checked?'checked':''} onchange="toggleItem(${idx})" style="width:20px;height:20px;accent-color:var(--success);">
                    <div style="flex:1"><b>${item.name}</b></div>
                    <button onclick="cart.splice(${idx},1);updateCartUI()" style="border:none;background:none;color:#dc3545;font-size:16px;"><i class="fas fa-trash-alt"></i></button>
                </div>
                <div class="cart-row-bottom">
                    <div class="qty-controls">
                        <button class="qty-btn" onclick="updateQty(${idx},-1)">-</button>
                        <span>${item.qty}</span>
                        <button class="qty-btn" onclick="updateQty(${idx},1)">+</button>
                    </div>
                    <div style="display:flex;align-items:center">
                        <input type="number" class="price-input" value="${item.price}" onchange="cart[${idx}].price=Number(this.value);updateTotal()">
                        <span>‡∏ø</span>
                    </div>
                </div>
            </div>`;
        });
        updateTotal();
    }

    function toggleItem(idx) { cart[idx].checked = !cart[idx].checked; updateCartUI(); }
    function updateQty(idx, val) { cart[idx].qty = Math.max(1, cart[idx].qty + val); updateCartUI(); }
    function updateTotal() {
        const total = cart.reduce((s, i) => s + (i.checked ? i.price * i.qty : 0), 0);
        document.getElementById('grandTotal').innerText = total.toLocaleString();
    }

    // =====================================
    // ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏£‡∏ñ‡πÅ‡∏•‡∏∞‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥ (‡∏î‡∏∂‡∏á‡∏ï‡∏∞‡∏Å‡∏£‡πâ‡∏≤‡∏ó‡∏µ‡πà‡∏ä‡πà‡∏≠‡∏á I)
    // =====================================
    function saveNewJob() {
        const p = document.getElementById('new-plate').value;
        const m = document.getElementById('new-mileage').value;
        const s = document.getElementById('new-symptoms').value;
        const mod = document.getElementById('new-model').value; // ‡∏£‡∏∏‡πà‡∏ô‡∏£‡∏ñ
        
        if(!p||!m||!s) return alert("‡∏Å‡∏£‡∏≠‡∏Å ‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô ‡πÑ‡∏°‡∏•‡πå ‡∏≠‡∏≤‡∏Å‡∏≤‡∏£ ‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö‡∏Ñ‡∏£‡∏±‡∏ö");
        
        document.querySelector('#mode-new .btn-primary').innerHTML = "‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å...";
        fetch(API, { method:'POST', body: JSON.stringify({ action:"add_job", plate:p, model:mod, mileage:m, details:"[‡∏≠‡∏≤‡∏Å‡∏≤‡∏£‡∏£‡∏±‡∏ö‡∏£‡∏ñ]:\n"+s }) })
        .then(r=>r.json()).then(d=>{ alert("‡πÄ‡∏õ‡∏¥‡∏î‡∏à‡πä‡∏≠‡∏ö‡πÉ‡∏´‡∏°‡πà‡πÅ‡∏•‡πâ‡∏ß!"); location.reload(); });
    }

    function fetchActiveJobs() {
        fetch(API+"?action=get_active_jobs").then(r=>r.json()).then(d=>{
            activeJobs = d.data;
            const s = document.getElementById('active-jobs-select'); 
            s.innerHTML = '<option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏ñ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• --</option>';
            activeJobs.forEach(j=> s.innerHTML += `<option value="${j.plate}">${j.plate}</option>`);
        });
    }

    // ‚úÖ ‡∏î‡∏∂‡∏á‡∏ï‡∏∞‡∏Å‡∏£‡πâ‡∏≤‡∏à‡∏≤‡∏Å‡∏ê‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏•‡∏±‡∏ö‡∏°‡∏≤
    function loadActiveJobData() {
        const p = document.getElementById('active-jobs-select').value;
        const job = activeJobs.find(x => String(x.plate) === String(p));
        
        if(job) { 
            document.getElementById('update-details').value = job.details;
            try { cart = JSON.parse(job.cartData || "[]"); } catch(e) { cart = []; }
            updateCartUI();
        } else {
            document.getElementById('update-details').value = "";
            cart = []; updateCartUI();
        }
    }

    function updateJob() {
        const plate = document.getElementById('active-jobs-select').value;
        if(!plate) return alert("‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏ñ‡∏Å‡πà‡∏≠‡∏ô‡∏Ñ‡∏£‡∏±‡∏ö");
        
        const status = document.getElementById('update-status').value;
        let details = document.getElementById('update-details').value;
        
        // ‡∏ñ‡πâ‡∏≤‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡πÄ‡∏Å‡πá‡∏ö‡∏ï‡∏±‡∏á‡∏Ñ‡πå (‡∏õ‡∏¥‡∏î‡∏à‡πä‡∏≠‡∏ö) ‡∏Ñ‡πà‡∏≠‡∏¢‡∏û‡∏¥‡∏°‡∏û‡πå‡∏™‡∏£‡∏∏‡∏õ‡∏•‡∏á‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥
        if(status !== '‡∏£‡∏≠‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£') {
            details += "\n\n[‡∏™‡∏£‡∏∏‡∏õ‡∏ö‡∏¥‡∏•‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô]:\n";
            cart.forEach(i => { 
                if(i.checked) details += `- ${i.name} (x${i.qty}) = ${i.price*i.qty} ‡∏ø\n`; 
                else details += `[‡πÄ‡∏•‡∏∑‡πà‡∏≠‡∏ô‡∏ó‡∏≥] ${i.name}\n`; 
            });
        }

        const payload = { 
            action: "update_job", 
            plate: plate, 
            details: details.trim(), 
            total: document.getElementById('grandTotal').innerText.replace(/,/g,''), 
            status: status,
            cartData: JSON.stringify(cart) // ‚úÖ ‡∏™‡πà‡∏á‡∏ï‡∏∞‡∏Å‡∏£‡πâ‡∏≤‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏õ‡πÄ‡∏ã‡∏ü‡∏ó‡∏µ‡πà‡∏ä‡πà‡∏≠‡∏á I ‡∏î‡πâ‡∏ß‡∏¢!
        };
        
        document.querySelector('#mode-update .btn-primary').innerHTML = "‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å...";
        fetch(API, { method:'POST', body: JSON.stringify(payload) })
        .then(r=>r.json()).then(d=>{ if(d.status==='success'){alert("‚úÖ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÅ‡∏•‡∏∞‡∏î‡∏≠‡∏á‡∏ö‡∏¥‡∏•‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢!"); location.reload();} });
    }

    // =====================================
    // E-Slip & History
    // =====================================
    function showBill() {
        const p = document.getElementById('active-jobs-select').value;
        const job = activeJobs.find(j => String(j.plate) === String(p));
        
        if(!p || !job) return alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏ñ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏ö‡∏¥‡∏•‡∏Ñ‡∏£‡∏±‡∏ö");
        
        document.getElementById('bill-date').innerText = new Date().toLocaleDateString('th-TH');
        document.getElementById('bill-plate').innerText = p;
        document.getElementById('bill-mile').innerText = job.mileage;
        
        const tbody = document.getElementById('bill-items-body'); tbody.innerHTML = '';
        cart.filter(i=>i.checked).forEach(i => {
            tbody.innerHTML += `<tr><td>${i.name} <span style="font-size:12px;color:#888">x${i.qty}</span></td><td style="text-align:right">${(i.price*i.qty).toLocaleString()}</td></tr>`;
        });
        
        document.getElementById('bill-total').innerText = document.getElementById('grandTotal').innerText;
        document.getElementById('bill-note').innerText = document.getElementById('update-details').value;
        document.getElementById('bill-modal').style.display='block';
    }

    function searchHistory() {
        const p = document.getElementById('histSearchPlate').value;
        if(!p) return;
        const resBox = document.getElementById('historyResults');
        resBox.innerHTML = '<p style="text-align:center;color:#888;"><i class="fas fa-spinner fa-spin"></i> ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤...</p>';
        fetch(API + "?action=get_history&plate=" + p).then(r=>r.json()).then(d=>{
            resBox.innerHTML = '';
            if(d.data.length === 0) resBox.innerHTML = '<p style="text-align:center;font-weight:bold;color:#dc3545;">‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡∏ô‡∏µ‡πâ</p>';
            d.data.forEach(h => {
                resBox.innerHTML += `<div class="history-card" style="border-top-color: ${h.status==='‡∏õ‡∏¥‡∏î‡∏à‡πä‡∏≠‡∏ö'?'#28a745':'#ffc107'}">
                    <span class="status-tag ${h.status==='‡∏õ‡∏¥‡∏î‡∏à‡πä‡∏≠‡∏ö'?'status-closed':'status-pending'}">${h.status}</span>
                    <div style="font-size:12px;color:#888">${h.date}</div>
                    <div style="font-weight:600;margin:5px 0">üöó ${h.plate} (‡πÑ‡∏°‡∏•‡πå: ${h.mileage})</div>
                    <div style="font-size:14px;white-space:pre-wrap;background:#fcfcfc;padding:8px;border-radius:6px;border:1px solid #eee;">${h.details}</div>
                    <div style="text-align:right;font-weight:bold;margin-top:8px;color:var(--success)">‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏°: ${h.total} ‡∏ø</div>
                </div>`;
            });
        });
    }
</script>
</body>
</html>
