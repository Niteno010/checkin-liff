<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    
    <title>‡∏£‡∏∞‡∏ö‡∏ö‡∏≠‡∏π‡πà - ‡πô ‡∏≠‡∏≠‡πÇ‡∏ï‡πâ ‡∏Å‡∏≤‡∏£‡∏≤‡∏à</title>
    <link href="https://fonts.googleapis.com/css2?family=Kanit:wght@300;400;500;600&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        :root { --bg: #f0f2f5; --primary: #1a1a1a; --accent: #ff3b30; --success: #28a745; --text: #333; --card-bg: #fff; }
        body { font-family: 'Kanit', sans-serif; background-color: var(--bg); color: var(--text); margin: 0; padding-bottom: 70px; }
        .container { padding: 15px; max-width: 600px; margin: 0 auto; }
        
        /* ‡πÄ‡∏°‡∏ô‡∏π‡∏•‡πà‡∏≤‡∏á */
        .bottom-nav { position: fixed; bottom: 0; left: 0; width: 100%; background: #fff; box-shadow: 0 -2px 10px rgba(0,0,0,0.1); display: flex; z-index: 1000; padding-bottom: env(safe-area-inset-bottom); }
        .nav-item { flex: 1; text-align: center; padding: 12px 0; color: #888; font-size: 13px; cursor: pointer; transition: 0.3s; position: relative; }
        .nav-item i { display: block; font-size: 20px; margin-bottom: 4px; }
        .nav-item.active { color: var(--primary); font-weight: 500; }
        .nav-item.active i { color: var(--accent); }
        .badge { position: absolute; top: 5px; right: 20vw; background: var(--accent); color: #fff; font-size: 11px; padding: 2px 6px; border-radius: 10px; font-weight: bold; display: none; }

        /* ‡∏™‡∏ß‡∏¥‡∏ï‡∏ä‡πå‡∏™‡∏•‡∏±‡∏ö‡πÇ‡∏´‡∏°‡∏î‡πÄ‡∏õ‡∏¥‡∏î‡∏à‡πä‡∏≠‡∏ö */
        .segment-control { display: flex; background: #e0e0e0; border-radius: 10px; padding: 4px; margin-bottom: 20px; }
        .seg-btn { flex: 1; text-align: center; padding: 12px 5px; border-radius: 8px; border: none; background: transparent; color: #666; font-size: 15px; font-family: 'Kanit'; font-weight: 500; cursor: pointer; transition: 0.3s; }
        .seg-btn.active { background: #fff; color: var(--primary); box-shadow: 0 2px 8px rgba(0,0,0,0.1); font-weight: 600; }

        .tab-content { display: none; animation: fadeIn 0.3s; }
        .tab-content.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        /* ‡∏ü‡∏≠‡∏£‡πå‡∏°‡πÅ‡∏•‡∏∞ Input */
        .search-box { background: var(--card-bg); padding: 15px; border-radius: 12px; position: sticky; top: 10px; z-index: 100; margin-bottom: 15px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        input[type="text"], input[type="number"], textarea, select { width: 100%; padding: 12px 15px; border: 1px solid #ddd; border-radius: 8px; font-family: 'Kanit'; font-size: 16px; box-sizing: border-box; background: #f9f9f9; }
        input:focus, textarea:focus, select:focus { outline: none; border-color: var(--accent); background: #fff; }
        textarea { min-height: 80px; resize: vertical; }

        .form-group { margin-bottom: 15px; }
        .form-group label { display: block; font-size: 14px; font-weight: 500; margin-bottom: 5px; color: #555; }
        .section-title { font-size: 18px; border-bottom: 2px solid #eee; padding-bottom: 8px; margin-bottom: 15px; color: var(--primary); margin-top: 15px; }

        /* ‡∏Å‡∏≤‡∏£‡πå‡∏î‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤ */
        .item-card { background: var(--card-bg); padding: 15px; border-radius: 12px; margin-bottom: 15px; border-left: 4px solid var(--primary); box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        .sell-price { color: var(--success); font-weight: bold; font-size: 18px; text-align: right; }
        .card-actions { display: flex; gap: 8px; margin-top: 10px; }
        .btn-add { flex: 2; background: #e8f5e9; color: var(--success); border: 1px solid var(--success); padding: 10px; border-radius: 8px; font-family: 'Kanit'; font-weight: 500; cursor: pointer; }
        .btn-edit { flex: 1; background: var(--primary); color: #fff; border: none; padding: 10px; border-radius: 8px; font-family: 'Kanit'; font-weight: 500; cursor: pointer; }

        /* ‡∏ï‡∏∞‡∏Å‡∏£‡πâ‡∏≤ UI */
        .cart-item { background: #f9f9f9; padding: 12px; border-radius: 8px; margin-bottom: 10px; border: 1px solid #eee; }
        .cart-item-header { display: flex; justify-content: space-between; margin-bottom: 8px; font-weight: 500; }
        .cart-item-price-row { display: flex; align-items: center; justify-content: space-between; }
        .price-input { width: 100px !important; padding: 8px !important; text-align: right; color: var(--success); font-weight: bold; border: 1px solid #ccc !important; }
        .btn-remove { color: #dc3545; background: none; border: none; font-size: 18px; cursor: pointer; padding: 5px; }
        .btn-custom { background: #fff; border: 1px dashed #aaa; color: #555; padding: 12px; width: 100%; border-radius: 8px; font-family: 'Kanit'; cursor: pointer; margin-bottom: 15px; }

        .total-box { background: var(--primary); color: #fff; padding: 15px; border-radius: 12px; text-align: right; font-size: 20px; font-weight: bold; margin-bottom: 20px; }
        .btn-submit { width: 100%; background: var(--primary); color: #fff; border: none; padding: 15px; border-radius: 12px; font-family: 'Kanit'; font-size: 16px; font-weight: bold; cursor: pointer; box-shadow: 0 4px 10px rgba(0,0,0,0.2); }
        .btn-submit.close-job { background: var(--success); box-shadow: 0 4px 10px rgba(40,167,69,0.2); }

        /* üî¥ CSS ‡∏õ‡πä‡∏≠‡∏õ‡∏≠‡∏±‡∏õ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏ê‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡∏´‡∏≤‡∏¢‡πÑ‡∏õ ‡πÄ‡∏≠‡∏≤‡∏Å‡∏•‡∏±‡∏ö‡∏°‡∏≤‡πÅ‡∏•‡πâ‡∏ß! üî¥ */
        .modal { display: none; position: fixed; z-index: 2000; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.6); backdrop-filter: blur(3px); }
        .modal-content { background-color: #fff; margin: 5vh auto; padding: 20px; border-radius: 16px; width: 90%; max-width: 450px; max-height: 85vh; overflow-y: auto; box-shadow: 0 10px 25px rgba(0,0,0,0.2); }
        .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; border-bottom: 1px solid #eee; padding-bottom: 10px; }
        .modal-header h3 { margin: 0; color: var(--primary); font-size: 18px; }
        .close-btn { color: #aaa; font-size: 24px; font-weight: bold; cursor: pointer; line-height: 1; }
        .modal-actions { display: flex; gap: 10px; margin-top: 20px; }
        .btn-save-modal { flex: 2; background: var(--accent); color: white; border: none; padding: 12px; border-radius: 8px; font-family: 'Kanit'; font-weight: 600; cursor: pointer; }
        .btn-delete-modal { flex: 1; background: #fff; color: #dc3545; border: 1px solid #dc3545; padding: 12px; border-radius: 8px; font-family: 'Kanit'; font-weight: 500; cursor: pointer; }
    </style>
</head>
<body>

<div id="tab-search" class="tab-content container active">
    <div class="search-box">
        <input type="text" id="searchInput" placeholder="üîç ‡∏û‡∏¥‡∏°‡∏û‡πå‡∏ä‡∏∑‡πà‡∏≠‡∏≠‡∏∞‡πÑ‡∏´‡∏•‡πà ‡∏´‡∏£‡∏∑‡∏≠ ‡∏£‡∏∏‡πà‡∏ô‡∏£‡∏ñ..." onkeyup="filterItems()">
    </div>
    <div id="loading" style="text-align: center; color: #888; padding: 20px;"><i class="fas fa-spinner fa-spin"></i> ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏ê‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...</div>
    <div id="resultsList"></div>
</div>

<div id="tab-job" class="tab-content container">
    <div class="segment-control">
        <button class="seg-btn active" id="btn-mode-new" onclick="setJobMode('new')">üÜï ‡∏£‡∏±‡∏ö‡∏£‡∏ñ‡πÄ‡∏Ç‡πâ‡∏≤‡πÉ‡∏´‡∏°‡πà</button>
        <button class="seg-btn" id="btn-mode-update" onclick="setJobMode('update')">üõ†Ô∏è ‡∏£‡∏ñ‡∏ó‡∏µ‡πà‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ã‡πà‡∏≠‡∏°</button>
    </div>

    <div id="mode-new">
        <div style="background: #fff3cd; color: #856404; padding: 10px; border-radius: 8px; font-size: 13px; margin-bottom: 15px;">
            <i class="fas fa-info-circle"></i> ‡πÇ‡∏´‡∏°‡∏î‡∏ô‡∏µ‡πâ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏à‡∏î‡∏£‡∏±‡∏ö‡∏£‡∏ñ‡πÄ‡∏ö‡∏∑‡πâ‡∏≠‡∏á‡∏ï‡πâ‡∏ô (‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏à‡∏∞‡∏ï‡∏±‡πâ‡∏á‡πÄ‡∏õ‡πá‡∏ô "‡∏£‡∏≠‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£")
        </div>
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
            <div class="form-group"><label>‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡∏£‡∏ñ <span style="color:red;">*</span></label><input type="text" id="new-plate" placeholder="‡∏Å‡∏Ç 1234"></div>
            <div class="form-group"><label>‡πÄ‡∏•‡∏Ç‡πÑ‡∏°‡∏•‡πå <span style="color:red;">*</span></label><input type="number" id="new-mileage" placeholder="120500"></div>
        </div>
        <div class="form-group"><label>‡∏£‡∏∏‡πà‡∏ô‡∏£‡∏ñ / ‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£</label><input type="text" id="new-model" placeholder="Almera / 08X-XXX-XXXX"></div>
        <div class="form-group"><label>‡∏≠‡∏≤‡∏Å‡∏≤‡∏£‡∏ó‡∏µ‡πà‡πÅ‡∏à‡πâ‡∏á <span style="color:red;">*</span></label><textarea id="new-symptoms" placeholder="‡πÄ‡∏ä‡πà‡∏ô ‡∏°‡∏µ‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡∏î‡∏±‡∏á‡∏•‡πâ‡∏≠‡∏´‡∏ô‡πâ‡∏≤..."></textarea></div>
        <button class="btn-submit" onclick="saveNewJob()"><i class="fas fa-save"></i> ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏£‡∏±‡∏ö‡∏£‡∏ñ (‡πÄ‡∏õ‡∏¥‡∏î‡∏à‡πä‡∏≠‡∏ö‡πÉ‡∏´‡∏°‡πà)</button>
    </div>

    <div id="mode-update" style="display: none;">
        <div class="form-group">
            <label><i class="fas fa-car-side"></i> ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏ñ‡∏ó‡∏µ‡πà‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ã‡πà‡∏≠‡∏° (‡∏£‡∏≠‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£)</label>
            <select id="active-jobs-select" onchange="loadActiveJobData()"><option value="">-- ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î... --</option></select>
        </div>
        <h3 class="section-title"><i class="fas fa-wrench"></i> ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ã‡πà‡∏≠‡∏° / ‡∏≠‡∏∞‡πÑ‡∏´‡∏•‡πà‡∏ö‡∏¥‡∏•‡∏ô‡∏µ‡πâ</h3>
        <div id="cartList" style="margin-bottom: 10px; font-size: 14px; color: #888; text-align: center; padding: 10px; background: #eee; border-radius: 8px;">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</div>
        <button class="btn-custom" onclick="addCustomItem()"><i class="fas fa-plus"></i> ‡∏û‡∏¥‡∏°‡∏û‡πå‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÄ‡∏≠‡∏á (‡∏Ñ‡πà‡∏≤‡πÅ‡∏£‡∏á/‡∏ü‡∏£‡∏µ)</button>
        <div class="form-group" style="margin-top: 15px;">
            <label>‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥/‡∏≠‡∏≤‡∏Å‡∏≤‡∏£/‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏ (‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÑ‡∏î‡πâ)</label>
            <textarea id="update-details"></textarea>
        </div>
        <div class="total-box">‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏°‡∏™‡∏∏‡∏ó‡∏ò‡∏¥: <span id="grandTotal">0</span> ‡∏ø</div>
        <div class="form-group" style="background: #e8f4f8; padding: 15px; border-radius: 12px; border: 1px solid #b8daff;">
            <label style="color: #0056b3;"><i class="fas fa-flag-checkered"></i> ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏ö‡∏¥‡∏•</label>
            <select id="update-status" style="font-weight: bold; color: #333;">
                <option value="‡∏õ‡∏¥‡∏î‡∏à‡πä‡∏≠‡∏ö">‚úÖ ‡∏õ‡∏¥‡∏î‡∏à‡πä‡∏≠‡∏ö (‡∏£‡∏±‡∏ö‡πÄ‡∏á‡∏¥‡∏ô‡∏ï‡∏≤‡∏°‡∏¢‡∏≠‡∏î‡∏Ç‡πâ‡∏≤‡∏á‡∏ö‡∏ô)</option>
                <option value="‡πÅ‡∏Ñ‡πà‡πÄ‡∏™‡∏ô‡∏≠‡∏£‡∏≤‡∏Ñ‡∏≤">üìù ‡πÅ‡∏Ñ‡πà‡πÄ‡∏™‡∏ô‡∏≠‡∏£‡∏≤‡∏Ñ‡∏≤ / ‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</option>
                <option value="‡∏£‡∏≠‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£">‚è≥ ‡∏£‡∏≠‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£ (‡∏î‡∏≠‡∏á‡∏ö‡∏¥‡∏•‡πÑ‡∏ß‡πâ‡∏ó‡∏≥‡∏ï‡πà‡∏≠)</option>
            </select>
        </div>
        <button class="btn-submit close-job" onclick="updateJob()"><i class="fas fa-save"></i> ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏£‡∏ñ‡∏Ñ‡∏±‡∏ô‡∏ô‡∏µ‡πâ</button>
    </div>
</div>

<div id="editModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h3><i class="fas fa-edit"></i> ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏ê‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏≠‡∏∞‡πÑ‡∏´‡∏•‡πà</h3>
            <span class="close-btn" onclick="closeModal()">&times;</span>
        </div>
        <input type="hidden" id="edit-id">
        <div class="form-group"><label>‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà</label><input type="text" id="edit-category"></div>
        <div class="form-group"><label>‡∏ä‡∏∑‡πà‡∏≠‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£ / ‡∏≠‡∏∞‡πÑ‡∏´‡∏•‡πà</label><input type="text" id="edit-name"></div>
        <div class="form-group"><label>‡∏£‡∏∏‡πà‡∏ô‡∏£‡∏ñ</label><input type="text" id="edit-model"></div>
        <div class="form-group"><label>‡∏ï‡πâ‡∏ô‡∏ó‡∏∏‡∏ô‡∏î‡∏¥‡∏ö (‡∏ö‡∏≤‡∏ó)</label><input type="number" id="edit-cost"></div>
        <div class="form-group">
            <label>‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏£‡∏≤‡∏Ñ‡∏≤</label>
            <select id="edit-priceType">
                <option value="‡∏ï‡πâ‡∏≠‡∏á‡∏ö‡∏ß‡∏Å‡∏™‡∏π‡∏ï‡∏£‡∏≠‡∏π‡πà">‡∏ï‡πâ‡∏≠‡∏á‡∏ö‡∏ß‡∏Å‡∏™‡∏π‡∏ï‡∏£‡∏≠‡∏π‡πà</option>
                <option value="‡∏£‡∏≤‡∏Ñ‡∏≤‡πÄ‡∏ô‡πá‡∏ï‡πÅ‡∏•‡πâ‡∏ß">‡∏£‡∏≤‡∏Ñ‡∏≤‡πÄ‡∏ô‡πá‡∏ï‡πÅ‡∏•‡πâ‡∏ß</option>
            </select>
        </div>
        <div class="form-group">
            <label>‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏Ç‡∏≠‡∏á</label>
            <select id="edit-status">
                <option value="‡∏°‡∏µ‡∏Ç‡∏≠‡∏á‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏ó‡∏≥">‡∏°‡∏µ‡∏Ç‡∏≠‡∏á‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏ó‡∏≥ / ‡πÄ‡∏ö‡∏¥‡∏Å‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏¢</option>
                <option value="‡∏™‡∏±‡πà‡∏á‡∏®‡∏π‡∏ô‡∏¢‡πå (‡∏£‡∏≠‡∏Ç‡∏≠‡∏á)">‡∏™‡∏±‡πà‡∏á‡∏®‡∏π‡∏ô‡∏¢‡πå (‡∏£‡∏≠‡∏Ç‡∏≠‡∏á)</option>
                <option value="‡πÄ‡∏ä‡πá‡∏Ñ‡∏™‡∏ï‡πä‡∏≠‡∏Å‡∏Å‡πà‡∏≠‡∏ô">‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏ä‡πá‡∏Ñ‡∏™‡∏ï‡πä‡∏≠‡∏Å‡∏Å‡πà‡∏≠‡∏ô</option>
            </select>
        </div>
        <div class="modal-actions">
            <button class="btn-save-modal" id="btnSaveDb" onclick="saveEdit()"><i class="fas fa-save"></i> ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</button>
            <button class="btn-delete-modal" id="btnDeleteDb" onclick="deleteItem()"><i class="fas fa-trash"></i> ‡∏•‡∏ö</button>
        </div>
    </div>
</div>

<nav class="bottom-nav">
    <div class="nav-item active" id="nav-search" onclick="switchTab('search')">
        <i class="fas fa-search"></i> ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏≠‡∏∞‡πÑ‡∏´‡∏•‡πà
    </div>
    <div class="nav-item" id="nav-job" onclick="switchTab('job')">
        <i class="fas fa-clipboard-list"></i> ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏à‡πä‡∏≠‡∏ö
        <span class="badge" id="cartBadge">0</span>
    </div>
</nav>

<script>
    const GOOGLE_SCRIPT_URL = "https://script.google.com/macros/s/AKfycbzgVz1m_VdZOyiLZjkbXaITInll47yRp1QmFDc6OCbdyedJLlcI-WXlNA1WBsWsEGwMJg/exec";
    
    let allItems = []; 
    let activeJobs = []; 
    let cart = []; 

    fetch(GOOGLE_SCRIPT_URL)
        .then(response => response.json())
        .then(data => {
            if(data.status === 'success') {
                allItems = data.data;
                document.getElementById('loading').style.display = 'none';
                renderItems(allItems); 
            }
        });

    function fetchActiveJobs() {
        fetch(GOOGLE_SCRIPT_URL + "?action=get_active_jobs")
            .then(response => response.json())
            .then(data => {
                if(data.status === 'success') {
                    activeJobs = data.data;
                    const select = document.getElementById('active-jobs-select');
                    select.innerHTML = '<option value="">-- ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏ñ --</option>';
                    if(activeJobs.length === 0) select.innerHTML = '<option value="">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏ñ‡∏Ñ‡πâ‡∏≤‡∏á‡∏ã‡πà‡∏≠‡∏° (‡∏ß‡πà‡∏≤‡∏á)</option>';
                    else activeJobs.forEach(job => select.innerHTML += `<option value="${job.plate}">${job.plate} (‡πÑ‡∏°‡∏•‡πå: ${job.mileage})</option>`);
                }
            });
    }
    fetchActiveJobs();

    // ==========================================
    // UI ‡∏™‡∏•‡∏±‡∏ö‡πÅ‡∏ó‡πá‡∏ö / ‡πÇ‡∏´‡∏°‡∏î
    // ==========================================
    function switchTab(tabName) {
        document.querySelectorAll('.tab-content').forEach(el => el.classList.remove('active'));
        document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
        document.getElementById('tab-' + tabName).classList.add('active');
        document.getElementById('nav-' + tabName).classList.add('active');
        window.scrollTo(0, 0); 
    }

    function setJobMode(mode) {
        document.getElementById('btn-mode-new').classList.remove('active');
        document.getElementById('btn-mode-update').classList.remove('active');
        document.getElementById('mode-new').style.display = 'none';
        document.getElementById('mode-update').style.display = 'none';
        document.getElementById('btn-mode-' + mode).classList.add('active');
        document.getElementById('mode-' + mode).style.display = 'block';
        if(mode === 'update') fetchActiveJobs(); 
    }

    // ==========================================
    // ‡∏£‡∏∞‡∏ö‡∏ö‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡πÅ‡∏•‡∏∞‡∏ï‡∏∞‡∏Å‡∏£‡πâ‡∏≤
    // ==========================================
    function filterItems() {
        const text = document.getElementById('searchInput').value.toLowerCase();
        const filtered = allItems.filter(item => item.name.toLowerCase().includes(text) || item.model.toLowerCase().includes(text));
        renderItems(filtered);
    }

    function renderItems(items) {
        const list = document.getElementById('resultsList');
        list.innerHTML = '';
        items.forEach(item => {
            const price = item.sellPrice ? item.sellPrice : 0;
            const costText = item.cost ? item.cost.toLocaleString() : '-'; // ‡πÅ‡∏≠‡∏ö‡πÇ‡∏ä‡∏ß‡πå‡∏ó‡∏∏‡∏ô‡∏à‡∏≤‡∏á‡πÜ ‡πÉ‡∏´‡πâ‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô‡∏î‡∏π
            list.innerHTML += `
                <div class="item-card">
                    <div style="display:flex; justify-content:space-between;">
                        <div>
                            <div style="font-weight:600; font-size:15px; color:var(--primary);">${item.name}</div>
                            <div style="font-size:12px; color:#666;">‡∏£‡∏∏‡πà‡∏ô: ${item.model} <span style="color:#aaa;">(‡∏ó‡∏∏‡∏ô: ${costText})</span></div>
                        </div>
                        <div class="sell-price">${price.toLocaleString()} ‡∏ø</div>
                    </div>
                    <div class="card-actions">
                        <button class="btn-add" onclick="addToCart('${item.name}', ${price})"><i class="fas fa-plus-circle"></i> ‡πÉ‡∏™‡πà‡∏ö‡∏¥‡∏•</button>
                        <button class="btn-edit" onclick="openEditModal('${item.id}')"><i class="fas fa-cog"></i> ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç</button>
                    </div>
                </div>
            `;
        });
    }

    function addToCart(name, price) { cart.push({ name: name, price: price }); updateCartUI(); alert(`‚úÖ ‡∏´‡∏¢‡∏¥‡∏ö "${name}" ‡πÉ‡∏™‡πà‡∏ö‡∏¥‡∏•‡πÅ‡∏•‡πâ‡∏ß`); }
    function addCustomItem() {
        const name = prompt("‡∏û‡∏¥‡∏°‡∏û‡πå‡∏ä‡∏∑‡πà‡∏≠‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£ (‡πÄ‡∏ä‡πà‡∏ô ‡∏•‡πâ‡∏≤‡∏á‡πÅ‡∏≠‡∏£‡πå, ‡∏Ñ‡πà‡∏≤‡πÅ‡∏£‡∏á):");
        if(name) { let price = prompt("‡πÉ‡∏™‡πà‡∏£‡∏≤‡∏Ñ‡∏≤ (‡∏ñ‡πâ‡∏≤‡∏ü‡∏£‡∏µ‡πÉ‡∏™‡πà 0):", "0"); cart.push({ name: name, price: parseInt(price) || 0 }); updateCartUI(); }
    }
    function removeFromCart(index) { cart.splice(index, 1); updateCartUI(); }
    function changeItemPrice(index, newPrice) { cart[index].price = parseInt(newPrice) || 0; updateTotal(); }

    function updateCartUI() {
        const list = document.getElementById('cartList'); const badge = document.getElementById('cartBadge');
        if(cart.length > 0) { badge.style.display = 'block'; badge.innerText = cart.length; list.style.background = 'transparent'; } 
        else { badge.style.display = 'none'; }
        list.innerHTML = '';
        if(cart.length === 0) list.innerHTML = '<div style="text-align:center; padding:10px; background:#eee; border-radius:8px;">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô‡∏£‡∏≤‡∏Ñ‡∏≤</div>';
        else {
            cart.forEach((item, index) => {
                list.innerHTML += `
                    <div class="cart-item">
                        <div class="cart-item-header"><span><b>${index+1}.</b> ${item.name}</span> <button class="btn-remove" onclick="removeFromCart(${index})"><i class="fas fa-trash-alt"></i></button></div>
                        <div class="cart-item-price-row">
                            <span style="font-size:12px; color:#888;">‡∏õ‡∏£‡∏±‡∏ö‡∏£‡∏≤‡∏Ñ‡∏≤ ‚ûî</span>
                            <div style="display:flex; align-items:center; gap:5px;"><input type="number" class="price-input" value="${item.price}" onkeyup="changeItemPrice(${index}, this.value)" onchange="changeItemPrice(${index}, this.value)"><span style="font-weight:bold;">‡∏ø</span></div>
                        </div>
                    </div>`;
            });
        }
        updateTotal();
    }
    function updateTotal() { document.getElementById('grandTotal').innerText = cart.reduce((sum, item) => sum + item.price, 0).toLocaleString(); }

    // ==========================================
    // üî¥ ‡∏£‡∏∞‡∏ö‡∏ö‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏ê‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• (‡∏Ç‡∏≠‡∏á‡πÄ‡∏î‡∏¥‡∏°‡∏ó‡∏µ‡πà‡∏´‡∏≤‡∏¢‡πÑ‡∏õ)
    // ==========================================
    function openEditModal(id) {
        const item = allItems.find(i => i.id === id);
        if(!item) return;
        document.getElementById('edit-id').value = item.id;
        document.getElementById('edit-category').value = item.category || '';
        document.getElementById('edit-name').value = item.name || '';
        document.getElementById('edit-model').value = item.model || '';
        document.getElementById('edit-cost').value = item.cost || '';
        document.getElementById('edit-priceType').value = item.priceType || '‡∏ï‡πâ‡∏≠‡∏á‡∏ö‡∏ß‡∏Å‡∏™‡∏π‡∏ï‡∏£‡∏≠‡∏π‡πà';
        document.getElementById('edit-status').value = item.status || '‡∏°‡∏µ‡∏Ç‡∏≠‡∏á‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏ó‡∏≥';
        document.getElementById('editModal').style.display = 'block';
    }

    function closeModal() { document.getElementById('editModal').style.display = 'none'; }
    window.onclick = function(event) { if (event.target == document.getElementById('editModal')) closeModal(); }

    function saveEdit() {
        const btn = document.getElementById('btnSaveDb'); btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å...'; btn.disabled = true;
        const payload = {
            action: "update", id: document.getElementById('edit-id').value, category: document.getElementById('edit-category').value,
            name: document.getElementById('edit-name').value, model: document.getElementById('edit-model').value, cost: document.getElementById('edit-cost').value,
            priceType: document.getElementById('edit-priceType').value, status: document.getElementById('edit-status').value
        };
        fetch(GOOGLE_SCRIPT_URL, { method: 'POST', body: JSON.stringify(payload), headers: { 'Content-Type': 'text/plain;charset=utf-8' } })
        .then(res => res.json()).then(data => {
            if(data.status === 'success') { alert("‚úÖ ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!"); location.reload(); }
            else { alert("‚ùå ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î"); btn.innerHTML = '‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•'; btn.disabled = false; }
        });
    }

    function deleteItem() {
        if(!confirm("‚ö†Ô∏è ‡πÅ‡∏ô‡πà‡πÉ‡∏à‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà‡∏ß‡πà‡∏≤‡∏à‡∏∞‡∏•‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ô‡∏µ‡πâ‡∏ñ‡∏≤‡∏ß‡∏£?")) return;
        const btn = document.getElementById('btnDeleteDb'); btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> ‡∏•‡∏ö...'; btn.disabled = true;
        fetch(GOOGLE_SCRIPT_URL, { method: 'POST', body: JSON.stringify({ action: "delete", id: document.getElementById('edit-id').value }), headers: { 'Content-Type': 'text/plain;charset=utf-8' } })
        .then(res => res.json()).then(data => {
            if(data.status === 'success') { alert("üóëÔ∏è ‡∏•‡∏ö‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!"); location.reload(); }
            else { alert("‚ùå ‡∏•‡∏ö‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à"); btn.innerHTML = '‡∏•‡∏ö'; btn.disabled = false; }
        });
    }

    // ==========================================
    // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏Ç‡πâ‡∏≤ Google Sheets (‡πÄ‡∏õ‡∏¥‡∏î‡∏à‡πä‡∏≠‡∏ö)
    // ==========================================
    function saveNewJob() {
        const plate = document.getElementById('new-plate').value, mileage = document.getElementById('new-mileage').value, symptoms = document.getElementById('new-symptoms').value;
        if (!plate || !mileage || !symptoms) { alert("‚ö†Ô∏è ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å ‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô, ‡πÑ‡∏°‡∏•‡πå ‡πÅ‡∏•‡∏∞ ‡∏≠‡∏≤‡∏Å‡∏≤‡∏£‡πÄ‡∏ö‡∏∑‡πâ‡∏≠‡∏á‡∏ï‡πâ‡∏ô ‡∏Ñ‡∏£‡∏±‡∏ö"); return; }
        submitData({ action: "add_job", plate: plate, model: document.getElementById('new-model').value, mileage: mileage, details: "[‡∏≠‡∏≤‡∏Å‡∏≤‡∏£‡∏£‡∏±‡∏ö‡∏£‡∏ñ]:\n" + symptoms, total: 0, phone: "" }, "‡πÄ‡∏õ‡∏¥‡∏î‡∏à‡πä‡∏≠‡∏ö‡πÉ‡∏´‡∏°‡πà‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢!");
    }

    function loadActiveJobData() {
        const job = activeJobs.find(j => j.plate === document.getElementById('active-jobs-select').value);
        document.getElementById('update-details').value = job ? job.details + "\n\n[‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï]:\n" : "";
    }

    function updateJob() {
        const plate = document.getElementById('active-jobs-select').value;
        if (!plate) { alert("‚ö†Ô∏è ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏ñ‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏Ñ‡∏£‡∏±‡∏ö"); return; }
        let currentDetails = document.getElementById('update-details').value;
        if(cart.length > 0) { currentDetails += `\n\n[‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£]:\n`; cart.forEach(item => currentDetails += `- ${item.name} (${item.price > 0 ? item.price+' ‡∏ö.' : '‡∏ü‡∏£‡∏µ'})\n`); }
        submitData({ action: "update_job", plate: plate, details: currentDetails.trim(), total: document.getElementById('grandTotal').innerText.replace(/,/g, ''), status: document.getElementById('update-status').value }, "‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏£‡∏ñ‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢!");
    }

    function submitData(payload, successMsg) {
        fetch(GOOGLE_SCRIPT_URL, { method: 'POST', body: JSON.stringify(payload), headers: { 'Content-Type': 'text/plain;charset=utf-8' } })
        .then(res => res.json()).then(data => { if(data.status === 'success') { alert("‚úÖ " + successMsg); location.reload(); } else alert("‚ùå ‡∏û‡∏•‡∏≤‡∏î‡πÅ‡∏•‡πâ‡∏ß: " + data.message); });
    }
</script>
</body>
</html>
