<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>‡πô ‡∏≠‡∏≠‡πÇ‡∏ï‡πâ ‡∏Å‡∏≤‡∏£‡∏≤‡∏à - Ultimate</title>
    <link href="https://fonts.googleapis.com/css2?family=Kanit:wght@300;400;500;600&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root { --bg: #f8f9fa; --primary: #1a1a1a; --accent: #ff3b30; --success: #28a745; --text: #333; --card: #fff; }
        body { font-family: 'Kanit', sans-serif; background: var(--bg); color: var(--text); margin: 0; padding-bottom: 80px; }
        .container { padding: 15px; max-width: 600px; margin: 0 auto; }
        
        /* Navigation */
        .bottom-nav { position: fixed; bottom: 0; left: 0; width: 100%; background: #fff; display: flex; box-shadow: 0 -2px 10px rgba(0,0,0,0.1); z-index: 1000; }
        .nav-item { flex: 1; text-align: center; padding: 12px 0; color: #999; font-size: 12px; cursor: pointer; }
        .nav-item i { display: block; font-size: 20px; margin-bottom: 3px; }
        .nav-item.active { color: var(--accent); }

        /* Tabs */
        .tab-content { display: none; animation: fadeIn 0.3s; }
        .tab-content.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; } }

        /* UI Elements */
        .search-box { background: var(--card); padding: 12px; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.05); margin-bottom: 15px; position: sticky; top: 10px; z-index: 100; }
        input, textarea, select { width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 8px; font-family: 'Kanit'; font-size: 16px; box-sizing: border-box; }
        .item-card { background: var(--card); padding: 15px; border-radius: 12px; margin-bottom: 12px; border-left: 4px solid var(--primary); box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        
        /* Cart Styles (Checkboxes & Quantity) */
        .cart-item { background: #fff; padding: 12px; border-radius: 10px; margin-bottom: 10px; border: 1px solid #eee; display: flex; flex-direction: column; gap: 8px; }
        .cart-row-top { display: flex; align-items: flex-start; gap: 10px; }
        .cart-row-bottom { display: flex; justify-content: space-between; align-items: center; background: #f9f9f9; padding: 8px; border-radius: 6px; }
        .qty-controls { display: flex; align-items: center; gap: 12px; background: #fff; border: 1px solid #ddd; border-radius: 6px; padding: 2px 8px; }
        .qty-btn { background: none; border: none; font-size: 18px; color: var(--accent); font-weight: bold; cursor: pointer; padding: 0 5px; }
        .price-input { width: 90px !important; text-align: right; font-weight: bold; color: var(--success); border: none !important; background: transparent !important; }
        
        /* Total & Buttons */
        .total-banner { background: var(--primary); color: #fff; padding: 15px; border-radius: 12px; text-align: right; font-size: 20px; font-weight: bold; margin: 15px 0; }
        .btn-main { width: 100%; padding: 15px; border: none; border-radius: 12px; font-family: 'Kanit'; font-size: 16px; font-weight: bold; cursor: pointer; }
        .btn-primary { background: var(--accent); color: #fff; }
        .btn-bill { background: #007bff; color: #fff; margin-bottom: 10px; }

        /* Timeline History */
        .history-card { background: #fff; padding: 15px; border-radius: 12px; margin-bottom: 15px; position: relative; border-top: 5px solid #ddd; }
        .status-tag { position: absolute; top: 10px; right: 10px; font-size: 11px; padding: 3px 8px; border-radius: 20px; }
        .status-closed { background: #e8f5e9; color: var(--success); }
        .status-pending { background: #fff3cd; color: #856404; }

        /* Modal */
        .modal { display: none; position: fixed; z-index: 2000; left:0; top:0; width:100%; height:100%; background: rgba(0,0,0,0.7); }
        .modal-content { background:#fff; margin:5% auto; padding:20px; width:90%; max-width:450px; border-radius:15px; }

        /* Bill Preview (E-Slip) */
        #bill-preview { background: #fff; padding: 20px; color: #000; display: none; border: 1px solid #ddd; }
        .bill-header { text-align: center; border-bottom: 2px dashed #eee; padding-bottom: 10px; margin-bottom: 15px; }
        .bill-table { width: 100%; border-collapse: collapse; font-size: 14px; }
        .bill-table th { text-align: left; border-bottom: 1px solid #eee; padding: 5px; }
        .bill-table td { padding: 8px 5px; border-bottom: 1px dotted #eee; }
    </style>
</head>
<body>

<div id="tab-search" class="tab-content container active">
    <div class="search-box"><input type="text" id="searchInput" placeholder="üîç ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏≠‡∏∞‡πÑ‡∏´‡∏•‡πà/‡∏£‡∏∏‡πà‡∏ô‡∏£‡∏ñ..." onkeyup="filterItems()"></div>
    <div id="loading" style="text-align:center; padding:20px; color:#888;"><i class="fas fa-spinner fa-spin"></i> ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...</div>
    <div id="resultsList"></div>
</div>

<div id="tab-job" class="tab-content container">
    <div style="display:flex; gap:10px; margin-bottom:15px;">
        <button onclick="setJobMode('new')" id="btn-m-new" style="flex:1; padding:10px; border-radius:8px; border:none; background:#eee;">‡∏£‡∏ñ‡πÉ‡∏´‡∏°‡πà</button>
        <button onclick="setJobMode('update')" id="btn-m-upd" style="flex:1; padding:10px; border-radius:8px; border:none; background:#eee;">‡∏Ñ‡πâ‡∏≤‡∏á‡∏ã‡πà‡∏≠‡∏°</button>
    </div>

    <div id="mode-new">
        <div style="display:grid; grid-template-columns:1fr 1fr; gap:10px; margin-bottom:10px;">
            <input type="text" id="new-plate" placeholder="‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô">
            <input type="number" id="new-mileage" placeholder="‡πÄ‡∏•‡∏Ç‡πÑ‡∏°‡∏•‡πå">
        </div>
        <textarea id="new-symptoms" placeholder="‡∏≠‡∏≤‡∏Å‡∏≤‡∏£‡∏ó‡∏µ‡πà‡πÅ‡∏à‡πâ‡∏á..." style="margin-bottom:10px;"></textarea>
        <button class="btn-main btn-primary" onclick="saveNewJob()">‡πÄ‡∏õ‡∏¥‡∏î‡∏à‡πä‡∏≠‡∏ö</button>
    </div>

    <div id="mode-update" style="display:none;">
        <select id="active-jobs-select" onchange="loadActiveJobData()" style="margin-bottom:10px;"><option>-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏ñ --</option></select>
        <div id="cartList"></div>
        <button onclick="addCustomItem()" style="width:100%; padding:10px; border:1px dashed #ccc; background:#fff; margin-bottom:15px; border-radius:8px;">+ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÄ‡∏≠‡∏á/‡∏Ñ‡πà‡∏≤‡πÅ‡∏£‡∏á</button>
        <textarea id="update-details" placeholder="‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏/‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥..." style="margin-bottom:10px;"></textarea>
        <div class="total-banner">‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏°‡∏™‡∏∏‡∏ó‡∏ò‡∏¥: <span id="grandTotal">0</span> ‡∏ø</div>
        <select id="update-status" style="margin-bottom:15px; font-weight:bold;">
            <option value="‡∏£‡∏≠‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£">‚è≥ ‡∏£‡∏≠‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£</option>
            <option value="‡∏õ‡∏¥‡∏î‡∏à‡πä‡∏≠‡∏ö">‚úÖ ‡∏õ‡∏¥‡∏î‡∏à‡πä‡∏≠‡∏ö (‡∏£‡∏±‡∏ö‡πÄ‡∏á‡∏¥‡∏ô)</option>
            <option value="‡πÅ‡∏Ñ‡πà‡πÄ‡∏™‡∏ô‡∏≠‡∏£‡∏≤‡∏Ñ‡∏≤">üìù ‡πÄ‡∏™‡∏ô‡∏≠‡∏£‡∏≤‡∏Ñ‡∏≤/‡πÄ‡∏•‡∏∑‡πà‡∏≠‡∏ô</option>
        </select>
        <button class="btn-main btn-bill" onclick="showBill()">üìÑ ‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÉ‡∏ö‡πÄ‡∏™‡∏ô‡∏≠‡∏£‡∏≤‡∏Ñ‡∏≤ (E-Slip)</button>
        <button class="btn-main btn-primary" onclick="updateJob()">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</button>
    </div>
</div>

<div id="tab-history" class="tab-content container">
    <div class="search-box">
        <input type="text" id="histSearchPlate" placeholder="üîç ‡πÉ‡∏™‡πà‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏î‡∏π‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥..." onkeyup="if(event.key==='Enter')searchHistory()">
        <button onclick="searchHistory()" style="margin-top:8px; width:100%; padding:8px; background:var(--primary); color:#fff; border:none; border-radius:8px;">‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤</button>
    </div>
    <div id="historyResults"></div>
</div>

<div id="bill-modal" class="modal">
    <div class="modal-content">
        <div id="bill-capture-area" style="background:#fff; padding:20px; border-radius:10px;">
            <div class="bill-header">
                <h2 style="margin:0;">‡πô ‡∏≠‡∏≠‡πÇ‡∏ï‡πâ ‡∏Å‡∏≤‡∏£‡∏≤‡∏à</h2>
                <p style="font-size:12px; margin:5px 0;">‡πÉ‡∏ö‡πÄ‡∏™‡∏ô‡∏≠‡∏£‡∏≤‡∏Ñ‡∏≤ / ‡∏™‡∏£‡∏∏‡∏õ‡∏á‡∏≤‡∏ô‡∏ã‡πà‡∏≠‡∏°</p>
                <div style="font-size:13px; text-align:left; margin-top:10px;">
                    <span id="bill-date"></span><br>
                    <b>‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô:</b> <span id="bill-plate"></span> | <b>‡πÑ‡∏°‡∏•‡πå:</b> <span id="bill-mile"></span>
                </div>
            </div>
            <table class="bill-table">
                <thead><tr><th>‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</th><th style="text-align:right;">‡∏£‡∏≤‡∏Ñ‡∏≤</th></tr></thead>
                <tbody id="bill-items-body"></tbody>
            </table>
            <div style="text-align:right; margin-top:15px; font-size:18px; font-weight:bold;">
                ‡∏£‡∏ß‡∏°‡∏ó‡∏±‡πâ‡∏á‡∏™‡∏¥‡πâ‡∏ô: <span id="bill-total"></span> ‡∏ø
            </div>
            <p id="bill-note" style="font-size:11px; color:#666; margin-top:10px; border-top:1px solid #eee; padding-top:10px;"></p>
        </div>
        <button onclick="document.getElementById('bill-modal').style.display='none'" style="width:100%; margin-top:15px; padding:10px; border:none; background:#eee; border-radius:8px;">‡∏õ‡∏¥‡∏î</button>
    </div>
</div>

<nav class="bottom-nav">
    <div class="nav-item active" onclick="switchTab('search', this)"><i class="fas fa-search"></i>‡∏≠‡∏∞‡πÑ‡∏´‡∏•‡πà</div>
    <div class="nav-item" onclick="switchTab('job', this)"><i class="fas fa-clipboard-list"></i>‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏à‡πä‡∏≠‡∏ö</div>
    <div class="nav-item" onclick="switchTab('history', this)"><i class="fas fa-history"></i>‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥</div>
</nav>

<script>
    const API = "https://script.google.com/macros/s/AKfycbynjKx-uvaVzPIbkGVYg427ibbqIthBRmEelqQf-g3CKchHvo6y9PFLz5jDrWqQvWdx/exec";
    let allItems = [], activeJobs = [], cart = [];

    fetch(API).then(r=>r.json()).then(d=>{ if(d.status==='success'){allItems=d.data; document.getElementById('loading').style.display='none'; renderItems(allItems);} });

    function switchTab(t, el) {
        document.querySelectorAll('.tab-content').forEach(c=>c.classList.remove('active'));
        document.querySelectorAll('.nav-item').forEach(i=>i.classList.remove('active'));
        document.getElementById('tab-'+t).classList.add('active');
        el.classList.add('active');
        if(t==='job') fetchActiveJobs();
    }

    function renderItems(items) {
        const list = document.getElementById('resultsList'); list.innerHTML = '';
        items.forEach(i => {
            list.innerHTML += `<div class="item-card">
                <div style="display:flex;justify-content:space-between">
                    <b>${i.name}</b><span style="color:var(--success)">${i.sellPrice}‡∏ø</span>
                </div>
                <div style="font-size:12px;color:#666">‡∏£‡∏∏‡πà‡∏ô: ${i.model}</div>
                <button onclick="addToCart('${i.name}', ${i.sellPrice})" style="width:100%;margin-top:10px;padding:8px;border:none;background:#e8f5e9;color:var(--success);border-radius:8px;">+ ‡πÉ‡∏™‡πà‡∏ö‡∏¥‡∏•</button>
            </div>`;
        });
    }

    function addToCart(name, price) {
        cart.push({ name: name, price: price, qty: 1, checked: true });
        updateCartUI();
        alert("‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÅ‡∏•‡πâ‡∏ß");
    }

    function updateCartUI() {
        const list = document.getElementById('cartList'); list.innerHTML = '';
        cart.forEach((item, idx) => {
            list.innerHTML += `<div class="cart-item" style="opacity: ${item.checked ? 1 : 0.5}">
                <div class="cart-row-top">
                    <input type="checkbox" ${item.checked?'checked':''} onchange="toggleItem(${idx})" style="width:20px;height:20px">
                    <div style="flex:1"><b>${item.name}</b></div>
                    <button onclick="cart.splice(${idx},1);updateCartUI()" style="border:none;background:none;color:red"><i class="fas fa-trash"></i></button>
                </div>
                <div class="cart-row-bottom">
                    <div class="qty-controls">
                        <button class="qty-btn" onclick="updateQty(${idx},-1)">-</button>
                        <span>${item.qty}</span>
                        <button class="qty-btn" onclick="updateQty(${idx},1)">+</button>
                    </div>
                    <div style="display:flex;align-items:center">
                        <input type="number" class="price-input" value="${item.price}" onchange="cart[${idx}].price=Number(this.value);updateTotal()">
                        <span>‡∏ø</span>
                    </div>
                </div>
            </div>`;
        });
        updateTotal();
    }

    function toggleItem(idx) { cart[idx].checked = !cart[idx].checked; updateCartUI(); }
    function updateQty(idx, val) { cart[idx].qty = Math.max(1, cart[idx].qty + val); updateCartUI(); }
    function updateTotal() {
        const total = cart.reduce((s, i) => s + (i.checked ? i.price * i.qty : 0), 0);
        document.getElementById('grandTotal').innerText = total.toLocaleString();
    }

    function searchHistory() {
        const p = document.getElementById('histSearchPlate').value;
        if(!p) return;
        const resBox = document.getElementById('historyResults');
        resBox.innerHTML = '<p style="text-align:center">üîç ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤...</p>';
        fetch(API + "?action=get_history&plate=" + p).then(r=>r.json()).then(d=>{
            resBox.innerHTML = '';
            if(d.data.length === 0) resBox.innerHTML = '<p>‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡∏ô‡∏µ‡πâ</p>';
            d.data.forEach(h => {
                resBox.innerHTML += `<div class="history-card" style="border-top-color: ${h.status==='‡∏õ‡∏¥‡∏î‡∏à‡πä‡∏≠‡∏ö'?'#28a745':'#ffc107'}">
                    <span class="status-tag ${h.status==='‡∏õ‡∏¥‡∏î‡∏à‡πä‡∏≠‡∏ö'?'status-closed':'status-pending'}">${h.status}</span>
                    <div style="font-size:12px;color:#888">${h.date}</div>
                    <div style="font-weight:600;margin:5px 0">${h.plate} | ‡πÑ‡∏°‡∏•‡πå: ${h.mileage}</div>
                    <div style="font-size:14px;white-space:pre-wrap;background:#fcfcfc;padding:8px;border-radius:6px">${h.details}</div>
                    <div style="text-align:right;font-weight:bold;margin-top:8px;color:var(--success)">‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏°: ${h.total} ‡∏ø</div>
                </div>`;
            });
        });
    }

    function showBill() {
        const p = document.getElementById('active-jobs-select').value;
        const job = activeJobs.find(j=>j.plate===p);
        if(!p || !job) return alert("‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏ñ‡∏Å‡πà‡∏≠‡∏ô‡∏Ñ‡∏£‡∏±‡∏ö");
        document.getElementById('bill-date').innerText = new Date().toLocaleDateString('th-TH');
        document.getElementById('bill-plate').innerText = p;
        document.getElementById('bill-mile').innerText = job.mileage;
        const tbody = document.getElementById('bill-items-body'); tbody.innerHTML = '';
        cart.filter(i=>i.checked).forEach(i => {
            tbody.innerHTML += `<tr><td>${i.name} x${i.qty}</td><td style="text-align:right">${(i.price*i.qty).toLocaleString()}</td></tr>`;
        });
        document.getElementById('bill-total').innerText = document.getElementById('grandTotal').innerText;
        document.getElementById('bill-note').innerText = document.getElementById('update-details').value;
        document.getElementById('bill-modal').style.display='block';
    }

    function updateJob() {
        const plate = document.getElementById('active-jobs-select').value;
        if(!plate) return alert("‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏ñ‡∏Å‡πà‡∏≠‡∏ô");
        let details = document.getElementById('update-details').value + "\n\n[‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ã‡πà‡∏≠‡∏°]:\n";
        cart.forEach(i => { if(i.checked) details += `- ${i.name} x${i.qty} (${i.price*i.qty}‡∏ø)\n`; else details += `[‡πÄ‡∏•‡∏∑‡πà‡∏≠‡∏ô] ${i.name}\n`; });
        const payload = { action: "update_job", plate: plate, details: details.trim(), total: document.getElementById('grandTotal').innerText.replace(/,/g,''), status: document.getElementById('update-status').value };
        fetch(API, { method:'POST', body: JSON.stringify(payload) }).then(r=>r.json()).then(d=>{ if(d.status==='success'){alert("‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÅ‡∏•‡πâ‡∏ß!"); location.reload();} });
    }

    // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏≠‡∏∑‡πà‡∏ô‡πÜ (saveNewJob, loadActiveJobData, etc.) ‡∏Ñ‡∏á‡πÄ‡∏î‡∏¥‡∏°‡∏ï‡∏≤‡∏° Logic ‡∏ó‡∏µ‡πà‡πÄ‡∏Ñ‡∏¢‡∏™‡πà‡∏á‡πÉ‡∏´‡πâ
    function setJobMode(m) {
        document.getElementById('mode-new').style.display = m==='new'?'block':'none';
        document.getElementById('mode-update').style.display = m==='update'?'block':'none';
    }
    function fetchActiveJobs() {
        fetch(API+"?action=get_active_jobs").then(r=>r.json()).then(d=>{
            const s = document.getElementById('active-jobs-select'); s.innerHTML = '<option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏ñ --</option>';
            d.data.forEach(j=> s.innerHTML += `<option value="${j.plate}">${j.plate}</option>`);
        });
    }
    function loadActiveJobData() {
        const j = activeJobs.find(x=>x.plate===document.getElementById('active-jobs-select').value);
        if(j) document.getElementById('update-details').value = j.details + "\n\n---\n";
    }
    function saveNewJob() {
        const p = document.getElementById('new-plate').value, m = document.getElementById('new-mileage').value, s = document.getElementById('new-symptoms').value;
        if(!p||!m||!s) return alert("‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö");
        fetch(API, { method:'POST', body: JSON.stringify({ action:"add_job", plate:p, mileage:m, details:s }) }).then(r=>r.json()).then(d=>{ alert("‡πÄ‡∏õ‡∏¥‡∏î‡∏à‡πä‡∏≠‡∏ö‡πÅ‡∏•‡πâ‡∏ß!"); location.reload(); });
    }
    function addCustomItem() {
        const n = prompt("‡∏ä‡∏∑‡πà‡∏≠‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£:"); if(!n) return;
        const p = prompt("‡∏£‡∏≤‡∏Ñ‡∏≤:", "0"); cart.push({ name:n, price:Number(p), qty:1, checked:true }); updateCartUI();
    }
</script>
</body>
</html>
