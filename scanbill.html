<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <title>AI สแกนบิลเข้าประวัติ - ๙ ออโต้ การาจ</title>
    <link href="https://fonts.googleapis.com/css2?family=Kanit:wght@300;400;500;600&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root { --bg: #f0f2f5; --primary: #1a1a1a; --accent: #2196F3; --success: #28a745; --text: #333; }
        body { font-family: 'Kanit', sans-serif; background-color: var(--bg); color: var(--text); padding: 15px; margin: 0; }
        .container { max-width: 600px; margin: 0 auto; background: #fff; padding: 20px; border-radius: 16px; box-shadow: 0 4px 15px rgba(0,0,0,0.05); }
        .header { text-align: center; margin-bottom: 20px; }
        .header h2 { color: var(--primary); margin: 0 0 5px 0; font-size: 22px; }
        .header p { margin: 0; color: #666; font-size: 13px; }
        
        .upload-area { border: 2px dashed #ccc; border-radius: 12px; padding: 30px 20px; text-align: center; cursor: pointer; margin-bottom: 20px; background: #fafafa; transition: 0.3s; }
        .upload-area:hover { border-color: var(--accent); background: #f0f8ff; }
        .upload-area i { font-size: 40px; color: var(--accent); margin-bottom: 10px; }
        #file-input { display: none; }
        
        #preview-img { max-width: 100%; border-radius: 8px; margin-top: 15px; display: none; border: 1px solid #eee; }
        
        .btn-scan { width: 100%; padding: 15px; background: linear-gradient(135deg, #2196F3, #1976D2); color: white; border: none; border-radius: 10px; font-size: 16px; font-weight: bold; cursor: pointer; margin-bottom: 20px; font-family: 'Kanit'; box-shadow: 0 4px 10px rgba(33,150,243,0.3); display: none; }
        .btn-scan:disabled { background: #90caf9; cursor: not-allowed; box-shadow: none; }
        
        .form-section { display: none; background: #f9f9f9; padding: 15px; border-radius: 12px; border: 1px solid #eee; }
        .form-section h3 { margin-top: 0; font-size: 16px; border-bottom: 2px solid #ddd; padding-bottom: 8px; color: var(--success); }
        .form-group { margin-bottom: 15px; }
        label { display: block; margin-bottom: 5px; font-size: 13px; font-weight: bold; color: #555; }
        input, textarea, select { width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 8px; font-family: 'Kanit'; font-size: 15px; box-sizing: border-box; }
        input:focus, textarea:focus { outline: none; border-color: var(--success); }
        textarea { height: 120px; resize: vertical; }
        
        .btn-save { width: 100%; padding: 15px; background: var(--success); color: white; border: none; border-radius: 10px; font-size: 16px; font-weight: bold; cursor: pointer; margin-top: 10px; font-family: 'Kanit'; }
        
        #loading-overlay { display: none; position: fixed; top:0; left:0; width:100%; height:100%; background:rgba(255,255,255,0.9); z-index: 1000; flex-direction: column; justify-content: center; align-items: center; }
        .spinner { border: 4px solid #f3f3f3; border-top: 4px solid var(--accent); border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; margin-bottom: 15px; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body>

<div class="container">
    <div class="header">
        <h2><i class="fas fa-robot"></i> สแกนบิลเก็บประวัติ</h2>
        <p>ถ่ายรูปบิล หรือแนบรูป เพื่อให้ AI ช่วยพิมพ์ลงฐานข้อมูล</p>
    </div>

    <div class="upload-area" onclick="document.getElementById('file-input').click()">
        <i class="fas fa-camera"></i>
        <div style="font-weight:bold; font-size:16px;">กดเพื่อถ่ายรูป หรือ เลือกรูปบิล</div>
        <div style="font-size:12px; color:#888; margin-top:5px;">รองรับ JPG, PNG (ระบบจะบีบอัดรูปให้อัตโนมัติ)</div>
        <input type="file" id="file-input" accept="image/*" capture="environment" onchange="previewImage(event)">
    </div>
    
    <img id="preview-img" alt="Preview">
    <button class="btn-scan" id="btn-scan" onclick="processWithAI()"><i class="fas fa-magic"></i> สแกนด้วย AI (ดึงข้อมูล)</button>

    <div class="form-section" id="form-section">
        <h3><i class="fas fa-check-circle"></i> ตรวจสอบข้อมูลก่อนบันทึก</h3>
        
        <div style="display:grid; grid-template-columns:1fr 1fr; gap:10px;">
            <div class="form-group"><label>ทะเบียนรถ</label><input type="text" id="ai-plate"></div>
            <div class="form-group"><label>รุ่นรถ</label><input type="text" id="ai-model"></div>
        </div>
        <div style="display:grid; grid-template-columns:1fr 1fr; gap:10px;">
            <div class="form-group"><label>เลขไมล์</label><input type="number" id="ai-mileage"></div>
            <div class="form-group"><label>เบอร์โทร</label><input type="text" id="ai-phone"></div>
        </div>
        
        <div class="form-group">
            <label>รายการซ่อม / อาการทั้งหมด (แก้ไขได้)</label>
            <textarea id="ai-details"></textarea>
        </div>
        
        <div class="form-group">
            <label>ยอดรวมสุทธิ (บาท)</label>
            <input type="number" id="ai-total">
        </div>

        <div class="form-group">
            <label>สถานะบิล</label>
            <select id="ai-status">
                <option value="ปิดจ๊อบ">✅ ปิดจ๊อบ (ประวัติย้อนหลัง)</option>
                <option value="รอดำเนินการ">⏳ รอดำเนินการ</option>
            </select>
        </div>

        <button class="btn-save" id="btn-save" onclick="saveToHistory()"><i class="fas fa-hdd"></i> บันทึกเข้าประวัติ (History)</button>
    </div>
</div>

<div id="loading-overlay">
    <div class="spinner"></div>
    <div id="loading-text" style="font-weight:bold; color:#555; text-align:center;">AI กำลังแกะลายมือ...<br><span style="font-size:12px; font-weight:normal;">(รอประมาณ 5-10 วินาที)</span></div>
</div>

<script>
    const GEMINI_API_KEY = "AIzaSyDVNLtzHZ4ZW9Rh7XhuvgTwBbyepWxao0A";
    const GAS_URL = "https://script.google.com/macros/s/AKfycbxIV0JWwjMWEnMoW6nZBaXGPvew6932N9Eh6bZG6ZV9tJRlbGuzzr9HRu5sJgJXu7jwnQ/exec";

    let base64Image = "";

    // ฟังก์ชันย่อขนาดและบีบอัดรูปก่อนส่ง (กันแอปค้าง)
    function previewImage(event) {
        const file = event.target.files[0];
        if (!file) return;

        const reader = new FileReader();
        reader.onload = function(e) {
            const img = new Image();
            img.onload = function() {
                const canvas = document.createElement('canvas');
                let width = img.width;
                let height = img.height;
                const MAX_WIDTH = 1000; // ย่อขนาดความกว้างไม่เกิน 1000px

                if (width > MAX_WIDTH) {
                    height = Math.round(height * (MAX_WIDTH / width));
                    width = MAX_WIDTH;
                }

                canvas.width = width;
                canvas.height = height;
                const ctx = canvas.getContext('2d');
                ctx.drawImage(img, 0, 0, width, height);
                
                // บีบอัดให้เป็น JPEG คุณภาพ 80%
                const dataUrl = canvas.toDataURL('image/jpeg', 0.8); 
                
                document.getElementById('preview-img').src = dataUrl;
                document.getElementById('preview-img').style.display = 'block';
                document.getElementById('btn-scan').style.display = 'block';
                document.getElementById('form-section').style.display = 'none';
                
                // ตัดส่วนหัว base64 ออก เตรียมส่งให้ AI
                base64Image = dataUrl.split(',')[1]; 
            }
            img.src = e.target.result;
        }
        reader.readAsDataURL(file);
    }

    async function processWithAI() {
        if (!base64Image) return alert("กรุณาเลือกรูปภาพก่อนครับ");
        
        document.getElementById('loading-overlay').style.display = 'flex';

        const promptText = `
        ดึงข้อมูลจากรูปบิลเงินสด/ใบเสร็จซ่อมรถนี้ 
        ให้อยู่ในรูปแบบ JSON เท่านั้น โดยมี key ดังนี้เป๊ะๆ ห้ามเปลี่ยนชื่อ:
        - "plate" : ทะเบียนรถ (ถ้าไม่มีให้ใส่ "")
        - "model" : รุ่นรถ (ถ้าไม่มีให้ใส่ "")
        - "mileage" : เลขไมล์ (เฉพาะตัวเลข ถ้าไม่มีให้ใส่ "")
        - "phone" : เบอร์โทร (ถ้าไม่มีให้ใส่ "")
        - "total" : ยอดรวมสุทธิ (เฉพาะตัวเลข ห้ามมีลูกน้ำ)
        - "details" : รายการซ่อมทั้งหมดและราคา เรียงเป็นข้อๆ ให้สวยงาม (เช่น - เปลี่ยนโช้ค 1500 บาท)
        ไม่ต้องมีเครื่องหมาย markdown ใดๆ ให้ส่งเป็น JSON ล้วนๆ เลย
        `;

        const requestBody = {
            contents: [{
                parts: [
                    { text: promptText },
                    { inline_data: { mime_type: "image/jpeg", data: base64Image } }
                ]
            }],
            generationConfig: { response_mime_type: "application/json" }
        };

        try {
            const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=${GEMINI_API_KEY}`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(requestBody)
            });

            const data = await response.json();
            if(data.error) throw new Error(data.error.message);

            const aiText = data.candidates[0].content.parts[0].text;
            
            // ป้องกัน AI ส่ง Markdown ติดมา
            let cleanJson = aiText.replace(/```json/gi, "").replace(/```/g, "").trim();
            const result = JSON.parse(cleanJson);

            document.getElementById('ai-plate').value = result.plate || "";
            document.getElementById('ai-model').value = result.model || "";
            document.getElementById('ai-mileage').value = result.mileage ? result.mileage.toString().replace(/,/g,'') : "";
            document.getElementById('ai-phone').value = result.phone || "";
            document.getElementById('ai-total').value = result.total || 0;
            
            let finalDetails = "[ข้อมูลจากสแกนบิล]\n" + (result.details || "ไม่พบรายการ");
            document.getElementById('ai-details').value = finalDetails;

            document.getElementById('form-section').style.display = 'block';
            document.getElementById('form-section').scrollIntoView({ behavior: 'smooth' });
            
        } catch (error) {
            alert("AI อ่านภาพไม่สำเร็จ กรุณาลองถ่ายรูปใหม่ให้ชัดเจนขึ้นครับ\n(หรืออาจเกิดจากปัญหาการเชื่อมต่อ)");
            console.error(error);
        } finally {
            document.getElementById('loading-overlay').style.display = 'none';
        }
    }

    function saveToHistory() {
        const plate = document.getElementById('ai-plate').value;
        const total = document.getElementById('ai-total').value;
        if(!plate) return alert("กรุณาใส่ทะเบียนรถก่อนบันทึกครับ");

        const payload = {
            action: "add_job",
            plate: plate,
            model: document.getElementById('ai-model').value,
            mileage: document.getElementById('ai-mileage').value,
            phone: document.getElementById('ai-phone').value,
            details: document.getElementById('ai-details').value,
            total: total ? Number(total) : 0,
            status: document.getElementById('ai-status').value 
        };

        const btnSave = document.getElementById('btn-save');
        btnSave.innerHTML = '<i class="fas fa-spinner fa-spin"></i> กำลังบันทึกลง Sheet...';
        btnSave.disabled = true;

        fetch(GAS_URL, {
            method: 'POST',
            body: JSON.stringify(payload)
        })
        .then(r => r.json())
        .then(d => {
            if(d.status === 'success') {
                alert("บันทึกประวัติจากบิลสำเร็จ!");
                location.reload(); 
            } else {
                alert("เกิดข้อผิดพลาด: " + d.message);
                btnSave.innerHTML = '<i class="fas fa-hdd"></i> บันทึกเข้าประวัติ (History)';
                btnSave.disabled = false;
            }
        })
        .catch(err => {
            alert("เชื่อมต่อฐานข้อมูลไม่ได้ครับ ลองใหม่อีกครั้ง");
            btnSave.innerHTML = '<i class="fas fa-hdd"></i> บันทึกเข้าประวัติ (History)';
            btnSave.disabled = false;
        });
    }
</script>
</body>
</html>
