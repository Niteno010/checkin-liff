<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <title>AI ‡∏™‡πÅ‡∏Å‡∏ô‡∏ö‡∏¥‡∏•‡πÄ‡∏Ç‡πâ‡∏≤‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥ - ‡πô ‡∏≠‡∏≠‡πÇ‡∏ï‡πâ ‡∏Å‡∏≤‡∏£‡∏≤‡∏à</title>
    <link href="https://fonts.googleapis.com/css2?family=Kanit:wght@300;400;500;600&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root { --bg: #f0f2f5; --primary: #1a1a1a; --accent: #2196F3; --success: #28a745; --text: #333; --warning: #ff9800; }
        body { font-family: 'Kanit', sans-serif; background-color: var(--bg); color: var(--text); padding: 15px; margin: 0; }
        .container { max-width: 600px; margin: 0 auto; background: #fff; padding: 20px; border-radius: 16px; box-shadow: 0 4px 15px rgba(0,0,0,0.05); }
        .header { text-align: center; margin-bottom: 20px; position: relative; }
        .header h2 { color: var(--primary); margin: 0 0 5px 0; font-size: 22px; }
        .header p { margin: 0; color: #666; font-size: 13px; }
        
        #api-setup-section { background: #fff3e0; padding: 20px; border-radius: 12px; border: 1px solid #ffe0b2; margin-bottom: 20px; text-align: center; display: none; }
        #key-input { width: 100%; padding: 12px; margin: 10px 0; border: 1px solid #ffb74d; border-radius: 8px; font-family: 'Kanit'; }
        .btn-save-key { background: var(--warning); color: #fff; border: none; padding: 10px 20px; border-radius: 8px; font-family: 'Kanit'; font-weight: bold; width: 100%; cursor: pointer; }
        .btn-reset-key { position: absolute; top: 0; right: 0; background: none; border: none; color: #999; font-size: 12px; text-decoration: underline; cursor: pointer; display: none; }

        .upload-area { border: 2px dashed #ccc; border-radius: 12px; padding: 30px 20px; text-align: center; cursor: pointer; margin-bottom: 20px; background: #fafafa; transition: 0.3s; }
        .upload-area i { font-size: 40px; color: var(--accent); margin-bottom: 10px; }
        #file-input { display: none; }
        
        #preview-img { max-width: 100%; border-radius: 8px; margin-top: 15px; display: none; border: 1px solid #eee; }
        
        .btn-scan { width: 100%; padding: 15px; background: linear-gradient(135deg, #2196F3, #1976D2); color: white; border: none; border-radius: 10px; font-size: 16px; font-weight: bold; cursor: pointer; margin-bottom: 20px; font-family: 'Kanit'; display: none; margin-top: 15px; }
        
        /* üö® ‡∏Å‡∏•‡πà‡∏≠‡∏á‡πÅ‡∏™‡∏î‡∏á Error ‡∏ö‡∏ô‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠ (‡∏Å‡∏±‡∏ô‡πÅ‡∏≠‡∏õ‡∏Ñ‡πâ‡∏≤‡∏á‡πÄ‡∏á‡∏µ‡∏¢‡∏ö‡πÜ) */
        #debug-box { background: #ffebee; color: #c62828; padding: 15px; border-radius: 8px; margin-top: 15px; border: 1px solid #ffcdd2; display: none; font-size: 13px; word-wrap: break-word; }
        
        .form-section { display: none; background: #f9f9f9; padding: 15px; border-radius: 12px; border: 1px solid #eee; }
        .form-section h3 { margin-top: 0; font-size: 16px; border-bottom: 2px solid #ddd; padding-bottom: 8px; color: var(--success); }
        .form-group { margin-bottom: 15px; }
        label { display: block; margin-bottom: 5px; font-size: 13px; font-weight: bold; color: #555; }
        input, textarea, select { width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 8px; font-family: 'Kanit'; font-size: 15px; box-sizing: border-box; }
        textarea { height: 120px; resize: vertical; }
        .btn-save { width: 100%; padding: 15px; background: var(--success); color: white; border: none; border-radius: 10px; font-size: 16px; font-weight: bold; cursor: pointer; margin-top: 10px; font-family: 'Kanit'; }
        
        #loading-overlay { display: none; position: fixed; top:0; left:0; width:100%; height:100%; background:rgba(255,255,255,0.9); z-index: 1000; flex-direction: column; justify-content: center; align-items: center; }
        .spinner { border: 4px solid #f3f3f3; border-top: 4px solid var(--accent); border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; margin-bottom: 15px; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body>

<div class="container">
    <div class="header">
        <h2><i class="fas fa-robot"></i> ‡∏™‡πÅ‡∏Å‡∏ô‡∏ö‡∏¥‡∏•‡πÄ‡∏Å‡πá‡∏ö‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥</h2>
        <p>‡∏£‡∏∞‡∏ö‡∏ö‡πÅ‡∏Å‡∏∞‡∏•‡∏≤‡∏¢‡∏°‡∏∑‡∏≠‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥ (AI)</p>
        <button id="btn-reset-key" class="btn-reset-key" onclick="resetApiKey()">‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô API Key</button>
    </div>

    <div id="api-setup-section">
        <i class="fas fa-key" style="font-size: 30px; color: var(--warning); margin-bottom: 10px;"></i>
        <h3 style="margin: 0;">‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏£‡∏∞‡∏ö‡∏ö AI ‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡πÅ‡∏£‡∏Å</h3>
        <p style="font-size: 12px; color: #666;">‡∏ß‡∏≤‡∏á‡∏£‡∏´‡∏±‡∏™ API Key ‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì ‡∏£‡∏´‡∏±‡∏™‡∏à‡∏∞‡∏ñ‡∏π‡∏Å‡πÄ‡∏Å‡πá‡∏ö‡πÉ‡∏ô‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô</p>
        <input type="password" id="key-input" placeholder="‡∏ß‡∏≤‡∏á API Key ‡∏•‡∏á‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà (AIzaSy...)">
        <button class="btn-save-key" onclick="saveApiKey()">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏∏‡∏ç‡πÅ‡∏à‡πÅ‡∏•‡∏∞‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô</button>
    </div>

    <div id="main-app-section" style="display: none;">
        <div class="upload-area" onclick="document.getElementById('file-input').click()">
            <i class="fas fa-camera"></i>
            <div style="font-weight:bold; font-size:16px;">‡∏Å‡∏î‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ñ‡πà‡∏≤‡∏¢‡∏£‡∏π‡∏õ ‡∏´‡∏£‡∏∑‡∏≠ ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏π‡∏õ‡∏ö‡∏¥‡∏•</div>
            <input type="file" id="file-input" accept="image/*" capture="environment" onchange="previewAndCompressImage(event)">
        </div>
        
        <img id="preview-img" alt="Preview">
        
        <div id="debug-box"></div>
        
        <button class="btn-scan" id="btn-scan" onclick="processWithAI()"><i class="fas fa-magic"></i> ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏™‡πÅ‡∏Å‡∏ô‡∏ö‡∏¥‡∏•‡∏î‡πâ‡∏ß‡∏¢ AI</button>

        <div class="form-section" id="form-section">
            <h3><i class="fas fa-check-circle"></i> ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡πà‡∏≠‡∏ô‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</h3>
            <div style="display:grid; grid-template-columns:1fr 1fr; gap:10px;">
                <div class="form-group"><label>‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡∏£‡∏ñ</label><input type="text" id="ai-plate"></div>
                <div class="form-group"><label>‡∏£‡∏∏‡πà‡∏ô‡∏£‡∏ñ</label><input type="text" id="ai-model"></div>
            </div>
            <div style="display:grid; grid-template-columns:1fr 1fr; gap:10px;">
                <div class="form-group"><label>‡πÄ‡∏•‡∏Ç‡πÑ‡∏°‡∏•‡πå</label><input type="number" id="ai-mileage"></div>
                <div class="form-group"><label>‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£</label><input type="text" id="ai-phone"></div>
            </div>
            <div class="form-group">
                <label>‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ã‡πà‡∏≠‡∏° / ‡∏≠‡∏≤‡∏Å‡∏≤‡∏£‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</label>
                <textarea id="ai-details"></textarea>
            </div>
            <div class="form-group">
                <label>‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏°‡∏™‡∏∏‡∏ó‡∏ò‡∏¥ (‡∏ö‡∏≤‡∏ó)</label>
                <input type="number" id="ai-total">
            </div>
            <div class="form-group">
                <label>‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏ö‡∏¥‡∏•</label>
                <select id="ai-status">
                    <option value="‡∏õ‡∏¥‡∏î‡∏à‡πä‡∏≠‡∏ö">‚úÖ ‡∏õ‡∏¥‡∏î‡∏à‡πä‡∏≠‡∏ö (‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏¢‡πâ‡∏≠‡∏ô‡∏´‡∏•‡∏±‡∏á)</option>
                    <option value="‡∏£‡∏≠‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£">‚è≥ ‡∏£‡∏≠‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£</option>
                </select>
            </div>
            <button class="btn-save" id="btn-save" onclick="saveToHistory()"><i class="fas fa-hdd"></i> ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏Ç‡πâ‡∏≤‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥ (History)</button>
        </div>
    </div>
</div>

<div id="loading-overlay">
    <div class="spinner"></div>
    <div id="loading-text" style="font-weight:bold; color:#555; text-align:center;">
        AI ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏•...<br><span style="font-size:12px; font-weight:normal;">(‡∏£‡∏≠‡∏õ‡∏£‡∏∞‡∏°‡∏≤‡∏ì 5-10 ‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ)</span>
    </div>
</div>

<script>
    const GAS_URL = "https://script.google.com/macros/s/AKfycby0PtS9tbnbCOISMQsS5i31b5MHWLO0qIiterzrAcVy2YchiGg2G93nfXIL8uGZnk5fzQ/exec";
    let base64Image = "";
    let apiKey = "";

    window.onload = function() { checkApiKey(); };

    function checkApiKey() {
        apiKey = localStorage.getItem("garage_ai_key");
        if (!apiKey) {
            document.getElementById('api-setup-section').style.display = 'block';
            document.getElementById('main-app-section').style.display = 'none';
            document.getElementById('btn-reset-key').style.display = 'none';
        } else {
            document.getElementById('api-setup-section').style.display = 'none';
            document.getElementById('main-app-section').style.display = 'block';
            document.getElementById('btn-reset-key').style.display = 'block';
        }
    }

    function saveApiKey() {
        const keyVal = document.getElementById('key-input').value.trim();
        if (!keyVal || !keyVal.startsWith("AIza")) {
            alert("API Key ‡∏ï‡πâ‡∏≠‡∏á‡∏Ç‡∏∂‡πâ‡∏ô‡∏ï‡πâ‡∏ô‡∏î‡πâ‡∏ß‡∏¢ AIza... ‡∏Ñ‡∏£‡∏±‡∏ö");
            return;
        }
        localStorage.setItem("garage_ai_key", keyVal);
        checkApiKey();
    }

    function resetApiKey() {
        if(confirm("‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô API Key ‡πÉ‡∏´‡∏°‡πà‡πÉ‡∏ä‡πà‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?")) {
            localStorage.removeItem("garage_ai_key");
            checkApiKey();
        }
    }

    function previewAndCompressImage(event) {
        document.getElementById('debug-box').style.display = 'none'; // ‡∏ã‡πà‡∏≠‡∏ô error ‡πÄ‡∏î‡∏¥‡∏°
        const file = event.target.files[0];
        if (!file) return;

        const reader = new FileReader();
        reader.onload = function(e) {
            const img = new Image();
            img.onload = function() {
                const canvas = document.createElement('canvas');
                let width = img.width;
                let height = img.height;
                const MAX_WIDTH = 800; 

                if (width > MAX_WIDTH) {
                    height = Math.round(height * (MAX_WIDTH / width));
                    width = MAX_WIDTH;
                }
                canvas.width = width;
                canvas.height = height;
                const ctx = canvas.getContext('2d');
                ctx.drawImage(img, 0, 0, width, height);
                
                const compressedDataUrl = canvas.toDataURL('image/jpeg', 0.8);
                document.getElementById('preview-img').src = compressedDataUrl;
                document.getElementById('preview-img').style.display = 'block';
                document.getElementById('btn-scan').style.display = 'block';
                document.getElementById('form-section').style.display = 'none';
                
                base64Image = compressedDataUrl.split(',')[1]; 
            }
            img.src = e.target.result;
        }
        reader.readAsDataURL(file);
    }

    async function processWithAI() {
        const debugBox = document.getElementById('debug-box');
        debugBox.style.display = 'none';
        
        if (!base64Image) {
            debugBox.innerHTML = "‚ùå ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û‡∏Ñ‡∏£‡∏±‡∏ö";
            debugBox.style.display = 'block';
            return;
        }
        
        document.getElementById('loading-overlay').style.display = 'flex';

        const promptText = `
        ‡∏≠‡πà‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å‡∏£‡∏π‡∏õ‡∏ö‡∏¥‡∏•‡∏ã‡πà‡∏≠‡∏°‡∏£‡∏ñ‡∏ô‡∏µ‡πâ 
        ‡∏™‡πà‡∏á‡∏Å‡∏•‡∏±‡∏ö‡∏°‡∏≤‡πÄ‡∏õ‡πá‡∏ô JSON ‡∏ï‡∏≤‡∏°‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡∏ô‡∏µ‡πâ‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô ‡∏´‡πâ‡∏≤‡∏°‡∏°‡∏µ‡∏Ñ‡∏≥‡∏≠‡∏ò‡∏¥‡∏ö‡∏≤‡∏¢‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°:
        {
          "plate": "‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡∏£‡∏ñ",
          "model": "‡∏£‡∏∏‡πà‡∏ô‡∏£‡∏ñ",
          "mileage": "‡πÄ‡∏•‡∏Ç‡πÑ‡∏°‡∏•‡πå (‡πÄ‡∏≠‡∏≤‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç)",
          "phone": "‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£",
          "total": "‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏° (‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô)",
          "details": "- ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£ 1\\n- ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£ 2"
        }
        ‡∏ñ‡πâ‡∏≤‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏´‡∏ô‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÉ‡∏ô‡∏ö‡∏¥‡∏• ‡πÉ‡∏´‡πâ‡πÄ‡∏ß‡πâ‡∏ô‡∏ß‡πà‡∏≤‡∏á‡πÄ‡∏õ‡πá‡∏ô ""
        `;

        const requestBody = {
            contents: [{
                parts: [
                    { text: promptText },
                    { inline_data: { mime_type: "image/jpeg", data: base64Image } }
                ]
            }],
            generationConfig: { response_mime_type: "application/json" }
        };

        try {
            const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=${apiKey}`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(requestBody)
            });

            const data = await response.json();
            
            // ‡πÄ‡∏ä‡πá‡∏Ñ Error ‡∏à‡∏≤‡∏Å‡πÄ‡∏ã‡∏¥‡∏£‡πå‡∏ü‡πÄ‡∏ß‡∏≠‡∏£‡πå Google
            if(data.error) {
                throw new Error("‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡∏à‡∏≤‡∏Å Google (Code " + data.error.code + "): " + data.error.message);
            }

            if(!data.candidates || data.candidates.length === 0) {
                throw new Error("AI ‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏•‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à‡πÅ‡∏ï‡πà‡πÑ‡∏°‡πà‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Å‡∏•‡∏±‡∏ö‡∏°‡∏≤‡∏Ñ‡∏£‡∏±‡∏ö");
            }

            const aiText = data.candidates[0].content.parts[0].text;
            let cleanJson = aiText.replace(/```json/gi, "").replace(/```/g, "").trim();
            
            let result;
            try {
                result = JSON.parse(cleanJson);
            } catch (e) {
                throw new Error("AI ‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏°‡∏≤‡∏ú‡∏¥‡∏î‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö (‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πà JSON):\n" + aiText);
            }

            // ‡∏´‡∏¢‡∏≠‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏•‡∏á‡∏ü‡∏≠‡∏£‡πå‡∏°
            document.getElementById('ai-plate').value = result.plate || "";
            document.getElementById('ai-model').value = result.model || "";
            document.getElementById('ai-mileage').value = result.mileage ? result.mileage.toString().replace(/,/g,'') : "";
            document.getElementById('ai-phone').value = result.phone || "";
            document.getElementById('ai-total').value = result.total || 0;
            let finalDetails = "[‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å‡∏™‡πÅ‡∏Å‡∏ô‡∏ö‡∏¥‡∏•]\n" + (result.details || "‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£");
            document.getElementById('ai-details').value = finalDetails;

            document.getElementById('form-section').style.display = 'block';
            document.getElementById('form-section').scrollIntoView({ behavior: 'smooth' });
            
        } catch (error) {
            // ‡πÇ‡∏ä‡∏ß‡πå Error ‡∏Ç‡∏∂‡πâ‡∏ô‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠‡∏ï‡∏±‡∏ß‡πÅ‡∏î‡∏á‡πÜ ‡πÅ‡∏ó‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏î‡πâ‡∏á Alert
            debugBox.innerHTML = "<b>‚ùå ‡∏û‡∏ö‡∏õ‡∏±‡∏ç‡∏´‡∏≤:</b><br>" + error.message + "<br><br><i>‡∏Ñ‡∏≥‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥: ‡∏•‡∏≠‡∏á‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏ß‡πá‡∏ö ‡∏´‡∏£‡∏∑‡∏≠‡∏Å‡∏î‡∏õ‡∏∏‡πà‡∏°‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô API Key ‡∏î‡πâ‡∏≤‡∏ô‡∏ö‡∏ô‡∏Ç‡∏ß‡∏≤‡∏Ñ‡∏£‡∏±‡∏ö</i>";
            debugBox.style.display = 'block';
            console.error(error);
        } finally {
            document.getElementById('loading-overlay').style.display = 'none';
        }
    }

    // ‡∏™‡πà‡∏ß‡∏ô‡∏Ç‡∏≠‡∏á Google Sheets ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÅ‡∏õ‡∏•‡∏á
    function saveToHistory() {
        // ... (‡πÇ‡∏Ñ‡πâ‡∏î‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡∏≠‡∏á‡πÄ‡∏î‡∏¥‡∏°) ...
        const plate = document.getElementById('ai-plate').value;
        const total = document.getElementById('ai-total').value;
        if(!plate) {
            document.getElementById('debug-box').innerHTML = "‚ùå ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÉ‡∏™‡πà‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡∏£‡∏ñ‡∏Å‡πà‡∏≠‡∏ô‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ñ‡∏£‡∏±‡∏ö";
            document.getElementById('debug-box').style.display = 'block';
            return;
        }

        const payload = {
            action: "add_job",
            plate: plate,
            model: document.getElementById('ai-model').value,
            mileage: document.getElementById('ai-mileage').value,
            phone: document.getElementById('ai-phone').value,
            details: document.getElementById('ai-details').value,
            total: total ? Number(total) : 0,
            status: document.getElementById('ai-status').value 
        };

        const btnSave = document.getElementById('btn-save');
        btnSave.innerHTML = '<i class="fas fa-spinner fa-spin"></i> ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏•‡∏á Sheet...';
        btnSave.disabled = true;

        fetch(GAS_URL, {
            method: 'POST',
            body: JSON.stringify(payload)
        })
        .then(r => r.json())
        .then(d => {
            if(d.status === 'success') {
                alert("‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏à‡∏≤‡∏Å‡∏ö‡∏¥‡∏•‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!");
                location.reload(); 
            } else {
                document.getElementById('debug-box').innerHTML = "‚ùå Error ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å Sheet: " + d.message;
                document.getElementById('debug-box').style.display = 'block';
                btnSave.innerHTML = '<i class="fas fa-hdd"></i> ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏Ç‡πâ‡∏≤‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥ (History)';
                btnSave.disabled = false;
            }
        })
        .catch(err => {
            document.getElementById('debug-box').innerHTML = "‚ùå ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏ê‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ ‡∏•‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡∏Ñ‡∏£‡∏±‡∏ö";
            document.getElementById('debug-box').style.display = 'block';
            btnSave.innerHTML = '<i class="fas fa-hdd"></i> ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏Ç‡πâ‡∏≤‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥ (History)';
            btnSave.disabled = false;
        });
    }
</script>
</body>
</html>
