<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>‡∏à‡∏≠‡∏á‡∏Ñ‡∏¥‡∏ß - 9 Auto Garage</title>
  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
  <link href="https://fonts.googleapis.com/css2?family=Kanit:wght@300;400;600&display=swap" rel="stylesheet">
   
  <style>
    body { background-color: #212529; color: #fff; font-family: 'Kanit', sans-serif; padding-bottom: 40px; }
    .main-card { max-width: 500px; margin: 20px auto; background: #fff; color: #333; border-radius: 15px; overflow: hidden; box-shadow: 0 10px 30px rgba(0,0,0,0.5); }
    .content-box { padding: 25px; }
    
    /* ‡∏õ‡∏∏‡πà‡∏°‡∏ï‡πà‡∏≤‡∏á‡πÜ */
    .btn-save-booking { background-color: #d63031; color: white; width: 100%; padding: 12px; border-radius: 8px; font-weight: bold; border: none; transition: 0.2s; }
    .btn-save-booking:hover { background-color: #b71c1c; }
    .btn-save-booking:disabled { background-color: #95a5a6; }

    .btn-find-q { background-color: #0984e3; color: white; border-radius: 8px; font-weight: bold; border: none; cursor: pointer; width: 80px; }
    .btn-find-q:hover { background-color: #076aad; }

    .btn-clear-q { background-color: #f1c40f; color: #333; border-radius: 8px; font-weight: bold; border: none; cursor: pointer; width: 50px; }
    .btn-clear-q:hover { background-color: #f39c12; }

    .btn-door { padding: 20px 15px; border-radius: 12px; font-size: 18px; font-weight: 600; margin-bottom: 15px; width: 100%; text-align: left; border: none; cursor: pointer; transition: transform 0.2s; }
    .btn-door:hover { transform: translateY(-3px); }
    .door-repair { background: #27ae60; color: white; }
    .door-claim { background: #f39c12; color: white; }
    
    /* ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞ */
    .status-badge { display: inline-block; padding: 5px 10px; border-radius: 15px; font-size: 12px; color: white; }
    .status-WAIT { background-color: #3498db !important; }
    .status-IN_BAY { background-color: #e67e22 !important; }
    .status-DONE { background-color: #2ecc71 !important; }
    .status-PICKED { background-color: #9b59b6 !important; }
    
    .profile-img { width: 40px; height: 40px; border-radius: 50%; margin-right: 10px; }

    /* Helper CSS */
    .w-25px { width: 25px; text-align: center; }

    /* Overlay Success */
    #success-overlay {
        position: fixed; top: 0; left: 0; width: 100%; height: 100%;
        background: rgba(0,0,0,0.85); z-index: 9999;
        display: none; align-items: center; justify-content: center; flex-direction: column;
    }
    .success-box {
        background: white; padding: 30px; border-radius: 20px; text-align: center; color: #333; width: 80%; max-width: 300px;
        animation: popup 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
    }
    @keyframes popup { from { transform: scale(0.5); opacity: 0; } to { transform: scale(1); opacity: 1; } }
  </style>
</head>
<body>

  <div id="success-overlay">
      <div class="success-box">
          <i class="fas fa-check-circle text-success fa-4x mb-3"></i>
          <h3>‡∏à‡∏≠‡∏á‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!</h3>
          <p class="text-muted">‡∏£‡∏∞‡∏ö‡∏ö‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÅ‡∏•‡πâ‡∏ß</p>
          <hr>
          <p class="mb-0 text-primary" style="font-weight:bold;">‡∏Å‡∏•‡∏±‡∏ö‡∏´‡∏ô‡πâ‡∏≤‡∏´‡∏•‡∏±‡∏Å‡πÉ‡∏ô <span id="countdown">3</span> ‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ</p>
      </div>
  </div>

  <div class="main-card">
    <div class="content-box">
      <div id="section-check" class="mb-5">
        <div class="text-center mb-4"><i class="fas fa-search fa-3x text-muted mb-3"></i><h5 class="text-dark">‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏Ñ‡∏¥‡∏ß</h5></div>
        
        <div class="input-group mb-3">
          <input type="text" id="q_search_plate" class="form-control form-control-lg" placeholder="‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô (‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏ß‡πâ‡∏ô‡∏ß‡∏£‡∏£‡∏Ñ)">
          <button class="btn btn-clear-q" type="button" onclick="clearSearch()"><i class="fas fa-times"></i></button>
          <button id="btnSearch" class="btn btn-find-q" type="button" onclick="checkQueue()">‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤</button>
        </div>

        <div id="resultCard" style="display:none; background:#f8f9fa; padding:15px; border-radius:8px; border-left:5px solid #00b894; margin-top:20px;">
          <div class="d-flex justify-content-between align-items-center mb-2">
            <strong id="resId" style="color:#d63031;">Q-XXXX</strong>
            <span id="resType" class="badge bg-secondary">‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏á‡∏≤‡∏ô</span>
          </div>
          <div class="mb-2"><span id="resStatus" class="status-badge bg-secondary">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</span></div>
          <hr>
          <p class="mb-1">üë§ <span id="resName">-</span></p>
          <p class="mb-1">üöô <span id="resModel" style="font-weight:bold; color:#0984e3;">-</span></p> <p class="mb-1">üõ† <span id="resService">-</span></p>
          <p class="mb-1 text-muted small">üìù <span id="resSymptom">-</span></p> <p class="mb-1 mt-2">üìÖ <span id="resDate">-</span> ‡πÄ‡∏ß‡∏•‡∏≤ <span id="resTime">-</span></p>
        </div>
        
        <div id="notFound" class="text-center text-danger mt-3" style="display:none;">‚ùå ‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Ñ‡∏£‡∏±‡∏ö</div>
      </div>
      <hr class="text-muted">

      <div id="section-landing" class="text-center mt-4">
        <h5 class="text-dark mb-4">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏á‡∏≤‡∏ô</h5>
        <div class="row">
          <div class="col-12"><button type="button" class="btn btn-door door-repair" onclick="goToBooking('SERVICE')"><i class="fas fa-wrench me-2"></i> ‡∏à‡∏≠‡∏á‡∏ã‡πà‡∏≠‡∏°‡∏ö‡∏≥‡∏£‡∏∏‡∏á</button></div>
          <div class="col-12"><button type="button" class="btn btn-door door-claim" onclick="goToBooking('CLAIM')"><i class="fas fa-paint-roller me-2"></i> ‡∏à‡∏≠‡∏á‡πÄ‡∏Ñ‡∏•‡∏°‡∏õ‡∏£‡∏∞‡∏Å‡∏±‡∏ô / ‡∏ó‡∏≥‡∏™‡∏µ</button></div>
        </div>
      </div>

      <div id="section-form" style="display:none;">
        <button type="button" class="btn btn-sm btn-outline-secondary mb-3" onclick="backToLanding()">‚ùÆ ‡∏¢‡πâ‡∏≠‡∏ô‡∏Å‡∏•‡∏±‡∏ö</button>
        <h5 class="text-dark mb-4 text-center" id="form-title"></h5>
        
        <div id="profile-box" class="mb-3 text-center text-muted" style="font-size:14px;"></div>

        <form onsubmit="sendBooking(event)">
          <input type="hidden" id="q_type">
          <input type="hidden" id="q_userId">
          
          <div class="mb-3"><label class="form-label text-dark">‡∏ä‡∏∑‡πà‡∏≠‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤</label><input type="text" id="q_name" class="form-control" required></div>
          <div class="row">
            <div class="col-6 mb-3"><label class="form-label text-dark">‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£</label><input type="tel" id="q_phone" class="form-control" required></div>
            <div class="col-6 mb-3"><label class="form-label text-dark">‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡∏£‡∏ñ</label><input type="text" id="q_plate" class="form-control" required placeholder="‡πÄ‡∏ä‡πà‡∏ô ‡∏Å‡∏Ç 1234"></div>
          </div>

          <div class="mb-3">
             <label class="form-label text-dark">‡∏£‡∏∏‡πà‡∏ô‡∏£‡∏ñ (‡∏¢‡∏µ‡πà‡∏´‡πâ‡∏≠/‡∏£‡∏∏‡πà‡∏ô/‡∏õ‡∏µ) <span class="text-danger">*</span></label>
             <input type="text" id="q_carModel" class="form-control" required placeholder="‡πÄ‡∏ä‡πà‡∏ô Honda Civic 2018">
          </div>

          <div class="mb-3"><label class="form-label text-dark">‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£</label><select id="q_service_dropdown" class="form-select" required></select></div>
          
          <div class="mb-3">
             <label class="form-label text-dark">‡∏≠‡∏≤‡∏Å‡∏≤‡∏£‡πÄ‡∏ö‡∏∑‡πâ‡∏≠‡∏á‡∏ï‡πâ‡∏ô (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ)</label>
             <textarea id="q_symptom" class="form-control" rows="2" placeholder="‡πÄ‡∏ä‡πà‡∏ô ‡∏°‡∏µ‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡∏î‡∏±‡∏á‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏•‡∏µ‡πâ‡∏¢‡∏ß, ‡πÅ‡∏≠‡∏£‡πå‡πÑ‡∏°‡πà‡πÄ‡∏¢‡πá‡∏ô"></textarea>
          </div>

          <div class="row">
            <div class="col-6 mb-3"><label class="form-label text-dark">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</label><input type="date" id="q_date" class="form-control" required></div>
            <div class="col-6 mb-3"><label class="form-label text-dark">‡πÄ‡∏ß‡∏•‡∏≤</label>
              <select id="q_time" class="form-select" required>
                 <option value="09:00">09:00</option><option value="10:00">10:00</option><option value="11:00">11:00</option>
                 <option value="13:00">13:00</option><option value="14:00">14:00</option><option value="15:00">15:00</option><option value="16:00">16:00</option>
              </select>
            </div>
          </div>
          <button type="submit" id="btnConfirm" class="btn-save-booking">‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏à‡∏≠‡∏á</button>
        </form>
      </div>
    </div>
  </div>

  <div class="modal fade" id="claimDocModal" data-bs-backdrop="static" data-bs-keyboard="false" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content" style="border-radius: 15px; border: none; overflow: hidden; color: #333;">
            <div class="modal-header bg-warning text-dark border-0">
                <h5 class="modal-title fw-bold"><i class="fas fa-file-invoice-dollar me-2"></i> ‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£‡∏á‡∏≤‡∏ô‡πÄ‡∏Ñ‡∏•‡∏° (‡∏≠‡∏π‡πà‡∏ô‡∏≠‡∏Å‡πÄ‡∏Ñ‡∏£‡∏∑‡∏≠)</h5>
            </div>
            <div class="modal-body p-4 bg-light">
                <p class="mb-3">‡∏£‡∏ö‡∏Å‡∏ß‡∏ô‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏°‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£‡πÉ‡∏ô‡∏ß‡∏±‡∏ô‡∏ô‡∏±‡∏î‡∏´‡∏°‡∏≤‡∏¢‡∏î‡∏±‡∏á‡∏ô‡∏µ‡πâ‡∏Ñ‡∏£‡∏±‡∏ö:</p>
                <div class="card border-0 shadow-sm mb-3">
                    <ul class="list-group list-group-flush rounded">
                        <li class="list-group-item"><i class="fas fa-file-alt text-primary me-2 w-25px"></i> 1. ‡πÉ‡∏ö‡πÄ‡∏Ñ‡∏•‡∏°‡∏ï‡∏±‡∏ß‡∏à‡∏£‡∏¥‡∏á</li>
                        <li class="list-group-item"><i class="fas fa-book text-danger me-2 w-25px"></i> 2. ‡∏™‡∏≥‡πÄ‡∏ô‡∏≤‡πÄ‡∏•‡πà‡∏°‡∏£‡∏ñ</li>
                        <li class="list-group-item"><i class="fas fa-shield-alt text-success me-2 w-25px"></i> 3. ‡∏™‡∏≥‡πÄ‡∏ô‡∏≤‡∏Å‡∏£‡∏°‡∏ò‡∏£‡∏£‡∏°‡πå‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô</li>
                        <li class="list-group-item"><i class="fas fa-id-card text-info me-2 w-25px"></i> 4. ‡∏™‡∏≥‡πÄ‡∏ô‡∏≤‡∏ö‡∏±‡∏ï‡∏£‡∏õ‡∏£‡∏∞‡∏ä‡∏≤‡∏ä‡∏ô (‡πÄ‡∏à‡πâ‡∏≤‡∏Ç‡∏≠‡∏á‡∏£‡∏ñ)</li>
                        <li class="list-group-item"><i class="fas fa-car-side text-secondary me-2 w-25px"></i> 5. ‡∏™‡∏≥‡πÄ‡∏ô‡∏≤‡πÉ‡∏ö‡∏Ç‡∏±‡∏ö‡∏Ç‡∏µ‡πà (‡∏ú‡∏π‡πâ‡∏Ç‡∏±‡∏ö‡∏Ç‡∏µ‡πà)</li>
                        <li class="list-group-item"><i class="fas fa-university text-warning me-2 w-25px"></i> 6. ‡∏™‡∏≥‡πÄ‡∏ô‡∏≤‡∏´‡∏ô‡πâ‡∏≤‡∏™‡∏°‡∏∏‡∏î‡∏ö‡∏±‡∏ç‡∏ä‡∏µ (‡πÄ‡∏à‡πâ‡∏≤‡∏Ç‡∏≠‡∏á‡∏£‡∏ñ)</li>
                        <li class="list-group-item">
                            <i class="fas fa-credit-card text-dark me-2 w-25px"></i> <strong>7. ‡∏ö‡∏±‡∏ï‡∏£ ATM ‡πÄ‡∏à‡πâ‡∏≤‡∏Ç‡∏≠‡∏á‡∏£‡∏ñ + ‡∏£‡∏´‡∏±‡∏™</strong><br>
                            <small class="text-muted ms-4">* ‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏Å‡∏£‡∏ì‡∏µ‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏™‡∏≥‡∏£‡∏≠‡∏á‡∏à‡πà‡∏≤‡∏¢‡πÄ‡∏á‡∏¥‡∏ô‡∏™‡∏î</small>
                        </li>
                    </ul>
                </div>
                <div class="alert alert-danger border-0 small mb-0">
                    <strong>‚ö†Ô∏è ‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏:</strong> ‡∏Å‡∏£‡∏ì‡∏µ‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡∏£‡∏≤‡∏Ñ‡∏≤‡πÅ‡∏•‡πâ‡∏ß‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡∏Ç‡∏≠‡πÉ‡∏ö‡πÄ‡∏Ñ‡∏•‡∏°‡∏Ñ‡∏∑‡∏ô ‡∏ó‡∏≤‡∏á‡∏≠‡∏π‡πà‡∏Ç‡∏≠‡∏Ñ‡∏¥‡∏î‡∏Ñ‡πà‡∏≤‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£ 7% ‡∏Ñ‡∏£‡∏±‡∏ö
                </div>
            </div>
            <div class="modal-footer border-0 bg-light">
                <button type="button" class="btn btn-dark w-100 py-2" data-bs-dismiss="modal">‡∏£‡∏±‡∏ö‡∏ó‡∏£‡∏≤‡∏ö‡πÅ‡∏•‡∏∞‡∏à‡∏≠‡∏á‡∏Ñ‡∏¥‡∏ß‡∏ï‡πà‡∏≠</button>
            </div>
        </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbydq7-dMcV6t0ZQVpNmxlZQAn0RibIkXLf9Nd5GlKMTophoMLEh3Di3lCCdLVyhR2HW/exec"; 
    const LIFF_ID = "2008842599-3Q9xZa0a"; 

    window.onload = async () => { await initLiff(); };

    async function initLiff() {
      try {
        await liff.init({ liffId: LIFF_ID });
        if (!liff.isLoggedIn()) { liff.login(); return; }
        const profile = await liff.getProfile();
        document.getElementById('q_userId').value = profile.userId;
        document.getElementById('profile-box').innerHTML = `<img src="${profile.pictureUrl}" class="profile-img"> ‡∏à‡∏≠‡∏á‡πÉ‡∏ô‡∏ô‡∏≤‡∏°: <b>${profile.displayName}</b>`;
        document.getElementById('q_name').value = profile.displayName;
      } catch (err) { console.error("LIFF Error", err); }
    }

    function goToBooking(type) {
        // ‚úÖ ‡∏ñ‡πâ‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏á‡∏≤‡∏ô CLAIM ‡πÉ‡∏´‡πâ‡πÇ‡∏ä‡∏ß‡πå‡∏õ‡πä‡∏≠‡∏õ‡∏≠‡∏±‡∏õ‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£
        if (type === 'CLAIM') {
            const claimModal = new bootstrap.Modal(document.getElementById('claimDocModal'));
            claimModal.show();
        }

        document.getElementById('section-landing').style.display = 'none';
        document.getElementById('section-form').style.display = 'block';
        document.getElementById('q_type').value = type;
        const dd = document.getElementById('q_service_dropdown');
        dd.innerHTML = '<option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£ --</option>';
        const opts = (type === 'SERVICE') ? ['‡∏ñ‡πà‡∏≤‡∏¢‡∏ô‡πâ‡∏≥‡∏°‡∏±‡∏ô‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á', '‡πÄ‡∏ä‡πá‡∏Ñ‡∏£‡∏∞‡∏¢‡∏∞', '‡∏ã‡πà‡∏≠‡∏°‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ', '‡∏•‡πâ‡∏≤‡∏á‡∏£‡∏ñ', '‡∏≠‡∏∑‡πà‡∏ô‡πÜ'] : ['‡πÄ‡∏Ñ‡∏•‡∏°‡∏õ‡∏£‡∏∞‡∏Å‡∏±‡∏ô (‡∏ã‡πà‡∏≠‡∏°‡∏ï‡∏±‡∏ß‡∏ñ‡∏±‡∏á)', '‡πÄ‡∏Ç‡πâ‡∏≤‡∏ó‡∏≥‡∏™‡∏µ (‡∏™‡πà‡∏ß‡∏ô‡∏ö‡∏∏‡∏Ñ‡∏Ñ‡∏•)', '‡∏ä‡∏ô‡πÄ‡∏ö‡∏≤/‡∏ó‡∏≥‡∏™‡∏µ‡∏î‡πà‡∏ß‡∏ô'];
        opts.forEach(x => dd.add(new Option(x, x)));
        document.getElementById('form-title').innerText = (type === 'SERVICE') ? 'üìÖ ‡∏à‡∏≠‡∏á‡∏Ñ‡∏¥‡∏ß: ‡∏ã‡πà‡∏≠‡∏°‡∏ö‡∏≥‡∏£‡∏∏‡∏á' : 'üìÖ ‡∏à‡∏≠‡∏á‡∏Ñ‡∏¥‡∏ß: ‡πÄ‡∏Ñ‡∏•‡∏°‡∏õ‡∏£‡∏∞‡∏Å‡∏±‡∏ô / ‡∏ó‡∏≥‡∏™‡∏µ';
    }
    
    function backToLanding() { document.getElementById('section-form').style.display = 'none'; document.getElementById('section-landing').style.display = 'block'; }

    function clearSearch() {
        document.getElementById('q_search_plate').value = '';
        document.getElementById('resultCard').style.display = 'none';
        document.getElementById('notFound').style.display = 'none';
    }

    function sendBooking(e) {
      e.preventDefault();
      const btn = document.getElementById('btnConfirm');
      const uid = document.getElementById('q_userId').value;
      if (!uid) {
          alert("‚ö†Ô∏è ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• LINE...\n‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏≠‡∏™‡∏±‡∏Å‡∏Ñ‡∏£‡∏π‡πà‡πÅ‡∏•‡πâ‡∏ß‡∏Å‡∏î‡πÉ‡∏´‡∏°‡πà‡∏Ñ‡∏£‡∏±‡∏ö");
          if(liff.isLoggedIn()) { liff.getProfile().then(p => document.getElementById('q_userId').value = p.userId); }
          return;
      }

      btn.innerText = '‚è≥ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å...'; 
      btn.disabled = true;
      
      let rawPlate = document.getElementById('q_plate').value;
      let cleanPlate = rawPlate.replace(/\s+/g, '');

      fetch(SCRIPT_URL, {
        method: 'POST', mode: 'no-cors', headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          name: document.getElementById('q_name').value, 
          phone: document.getElementById('q_phone').value,
          plate: cleanPlate,
          carModel: document.getElementById('q_carModel').value,
          service: document.getElementById('q_service_dropdown').value,
          symptom: document.getElementById('q_symptom').value, 
          date: document.getElementById('q_date').value, 
          time: document.getElementById('q_time').value,
          type: document.getElementById('q_type').value,
          userId: uid
        })
      }).then(() => { 
          if (liff.isInClient()) {
             liff.sendMessages([{ type: 'text', text: `üìù ‡∏à‡∏≠‡∏á‡∏Ñ‡∏¥‡∏ß‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!\n‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô: ${rawPlate}\n‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà: ${document.getElementById('q_date').value} ‡πÄ‡∏ß‡∏•‡∏≤ ${document.getElementById('q_time').value}\n*‡∏£‡∏≠‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô` }]).catch(e=>{});
          }
          showSuccessAndClear();
      }).catch(err => { 
          alert("‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠"); 
          btn.innerText = '‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏à‡∏≠‡∏á';
          btn.disabled = false; 
      });
    }

    function showSuccessAndClear() {
        const overlay = document.getElementById('success-overlay');
        const countSpan = document.getElementById('countdown');
        let seconds = 3;
        overlay.style.display = 'flex';
        const timer = setInterval(() => {
            seconds--;
            countSpan.innerText = seconds;
            if (seconds <= 0) {
                clearInterval(timer);
                overlay.style.display = 'none';
                document.querySelector('form').reset(); 
                document.getElementById('btnConfirm').innerText = '‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏à‡∏≠‡∏á';
                document.getElementById('btnConfirm').disabled = false;
                backToLanding();
                window.scrollTo({ top: 0, behavior: 'smooth' });
            }
        }, 1000);
    }

    function checkQueue() {
      const plate = document.getElementById('q_search_plate').value;
      if(!plate) return alert("‡∏£‡∏∞‡∏ö‡∏∏‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡∏£‡∏ñ");
      const btn = document.getElementById('btnSearch');
      const cleanPlate = plate.replace(/\s+/g, '');
      btn.innerText = '‚è≥...'; btn.disabled = true;
      
      fetch(SCRIPT_URL + "?action=search&plate=" + encodeURIComponent(cleanPlate))
      .then(res => res.json()).then(data => {
        btn.innerText = '‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤'; btn.disabled = false;
        document.getElementById('notFound').style.display = 'none';
        
        if(data.result === 'found') {
          const info = data.data;
          document.getElementById('resultCard').style.display = 'block';
          document.getElementById('resId').innerText = info.id;
          document.getElementById('resName').innerText = info.name;
          document.getElementById('resService').innerText = info.service;
          document.getElementById('resModel').innerText = info.carModel || '-';
          document.getElementById('resSymptom').innerText = info.symptom || '-';
          
          let showDate = info.date;
          if(showDate.includes('-')) {
             const p = showDate.split('-');
             if(p.length===3) showDate = `${p[2]}/${p[1]}/${p[0]}`;
          }
          document.getElementById('resDate').innerText = showDate;
          document.getElementById('resTime').innerText = info.time;
          const map = {'WAIT':'‡∏£‡∏≠‡∏Å‡∏≤‡∏£‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£','IN_BAY':'‡∏≠‡∏¢‡∏π‡πà‡∏£‡∏∞‡∏´‡∏ß‡πà‡∏≤‡∏á‡∏ã‡πà‡∏≠‡∏°/‡∏™‡∏µ','DONE':'‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô/‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏£‡∏±‡∏ö‡∏£‡∏ñ','PICKED':'‡∏£‡∏±‡∏ö‡∏£‡∏ñ‡πÅ‡∏•‡πâ‡∏ß'};
          document.getElementById('resStatus').innerText = map[info.status] || info.status;
          document.getElementById('resStatus').className = `status-badge status-${info.status}`;
          document.getElementById('resType').innerText = info.type === 'CLAIM' ? '‡πÄ‡∏Ñ‡∏•‡∏°/‡∏ó‡∏≥‡∏™‡∏µ' : '‡∏ã‡πà‡∏≠‡∏°‡∏ö‡∏≥‡∏£‡∏∏‡∏á';
        } else { 
            document.getElementById('resultCard').style.display = 'none'; 
            document.getElementById('notFound').style.display = 'block'; 
        }
      }).catch(err => { alert("‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ"); btn.disabled = false; });
    }
  </script>
</body>
</html>
